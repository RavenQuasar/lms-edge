<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LMS-Edge ç­çº§å±€åŸŸç½‘æ•™å­¦ç®¡ç†ç³»ç»Ÿ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh}
a{color:#667eea;text-decoration:none;cursor:pointer}
a:hover{text-decoration:underline}
button{cursor:pointer}
input[type="checkbox"],input[type="radio"]{cursor:pointer}
select{cursor:pointer}
.container{max-width:1400px;margin:0 auto;padding:20px}
.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh}
.login-box{background:white;padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:100%;max-width:450px;text-align:center}
.dashboard-container{display:none}
.header{background:white;padding:15px 20px;border-radius:15px;margin-bottom:20px;box-shadow:0 5px 20px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.header h1{color:#333;font-size:20px}
.header .user-info{color:#666;font-size:14px}
.header .user-info span{margin-left:15px}
.logout-btn{background:#ff6b6b;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px}
.logout-btn:hover{background:#ee5a5a}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}
.stat-card{background:white;padding:20px;border-radius:12px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,0.08)}
.stat-card h3{color:#667eea;font-size:28px;margin-bottom:5px}
.stat-card p{color:#666;font-size:13px}
.nav-tabs{background:white;padding:12px;border-radius:12px;margin-bottom:20px;display:flex;flex-wrap:wrap;gap:5px;box-shadow:0 3px 10px rgba(0,0,0,0.08)}
.nav-tabs button{flex:1;min-width:100px;padding:12px;border:none;background:white;color:#666;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.2s}
.nav-tabs button:hover{background:#f5f5f5}
.nav-tabs button.active{background:#667eea;color:white}
.content-section{display:none;background:white;padding:20px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.08)}
.content-section.active{display:block}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.2s}
.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
.btn-primary:hover{opacity:0.9}
.btn-success{background:#6bcb77;color:white}
.btn-danger{background:#ff6b6b;color:white}
.btn-warning{background:#ffd93d;color:#333}
.btn-sm{padding:6px 12px;font-size:12px}
.btn:hover{opacity:0.9}
.form-group{margin-bottom:15px;text-align:left}
.form-group label{display:block;margin-bottom:5px;color:#333;font-weight:500;font-size:14px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px}
.form-group textarea{resize:vertical;min-height:80px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px}
th,td{padding:12px;text-align:left;border-bottom:1px solid #eee}
th{background:#f5f5f5;color:#333;font-weight:600}
tr:hover{background:#fafafa}
.role-badge{padding:3px 8px;border-radius:4px;font-size:12px;color:white}
.role-admin{background:#ff6b6b}
.role-teacher{background:#ffd93d;color:#333}
.role-student{background:#6bcb77}
.action-btns{display:flex;gap:5px;flex-wrap:wrap}
.online-badge{background:#6bcb77;color:white;padding:2px 8px;border-radius:10px;font-size:11px}
.offline-badge{background:#999;color:white;padding:2px 8px;border-radius:10px;font-size:11px}
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center}
.modal-overlay.active{display:flex}
.modal{background:white;padding:30px 25px 25px;border-radius:15px;width:95%;max-width:600px;max-height:90vh;overflow-y:auto;position:relative}
.modal h2{margin-bottom:20px;color:#333;font-size:18px}
.modal .close-btn{position:absolute;top:10px;right:15px;background:none;border:none;font-size:28px;cursor:pointer;color:#999;line-height:1;z-index:10}
.modal .close-btn:hover{color:#333}
.detail-view{background:#f5f5f5;padding:15px;border-radius:8px;margin:10px 0}
.detail-view h4{margin-bottom:10px;color:#333}
.alert{padding:12px;border-radius:8px;margin-bottom:15px;font-size:14px}
.alert-error{background:#ffe6e6;color:#cc0000}
.alert-success{background:#e6ffe6;color:#006600}
.filter-bar{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;align-items:center}
.filter-bar input,.filter-bar select{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px}
.log-entry{padding:10px;border-bottom:1px solid #eee;font-size:13px}
.log-entry .time{color:#999;font-size:12px}
.log-entry .action{color:#667eea;font-weight:500}
.empty-message{text-align:center;color:#999;padding:30px}
.option-item{display:flex;gap:8px;margin-bottom:6px;align-items:center;width:100%}
.option-item input[type="radio"],.option-item input[type="checkbox"]{width:auto;flex:none;margin:0;cursor:pointer}
.option-item label{flex:1;cursor:pointer;word-break:break-word;line-height:1.4}
.file-upload{border:2px dashed #ddd;padding:20px;text-align:center;border-radius:8px;cursor:pointer;margin:10px 0}
.file-upload:hover{border-color:#667eea}
.file-list{list-style:none;padding:0}
.file-list li{padding:8px;background:#f5f5f5;margin:5px 0;border-radius:5px;display:flex;justify-content:space-between;align-items:center}
.file-icon{margin-right:8px}
.whiteboard-container{background:white;border-radius:8px;padding:10px;margin:10px 0}
.whiteboard-toolbar{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.whiteboard-toolbar button{padding:8px 15px;border:1px solid #ddd;background:white;border-radius:5px;cursor:pointer}
.whiteboard-toolbar button.active{background:#667eea;color:white;border-color:#667eea}
.whiteboard-canvas{width:100%;height:400px;border:1px solid #ddd;border-radius:8px;cursor:crosshair}
.game-item-slot{width:36px;height:36px;background:#f5f5f5;border-radius:8px;display:flex;justify-content:center;align-items:center;font-size:18px;border:1px solid #ddd}
.game-option-btn{background:#f8f9fa;border:1.5px solid #f1f2f6;padding:12px 15px;border-radius:12px;cursor:pointer;text-align:left;transition:0.2s}
.game-option-btn:hover{background:#f0edff;border-color:#a29bfe}
.game-option-btn.selected{background:#f0edff;border-color:#a29bfe}
.game-option-btn.correct{background:#55efc4 !important;border-color:#55efc4 !important;color:white}
.game-option-btn.wrong{background:#ff7675 !important;border-color:#ff7675 !important;color:white}
@media (max-width:768px){.form-row{grid-template-columns:1fr}.header{text-align:center}.header h1{width:100%}}
</style>
</head>
<body>
<div id="loginContainer" class="login-container">
<div class="login-box">
<h1 style="margin-bottom:10px">LMS-Edge</h1>
<p class="subtitle" style="color:#666;margin-bottom:25px">ç­çº§å±€åŸŸç½‘æ•™å­¦ç®¡ç†ç³»ç»Ÿ</p>
<div class="form-group">
<label>ç”¨æˆ·å</label>
<input type="text" id="username" placeholder="admin / teacher / student">
</div>
<div class="form-group">
<label>å¯†ç </label>
<input type="password" id="password" placeholder="è¾“å…¥å¯†ç ">
</div>
<button class="btn btn-primary" style="width:100%;padding:12px;font-size:16px" onclick="doLogin()">ç™»å½•</button>
<div style="margin-top:20px;text-align:left;background:#f5f5f5;padding:15px;border-radius:10px">
<h4 style="margin-bottom:10px;font-size:14px">æµ‹è¯•è´¦å·</h4>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
<div><span class="role-badge role-admin">ç®¡ç†å‘˜</span> admin / admin123</div>
<div><span class="role-badge role-teacher">è€å¸ˆ</span> teacher / teacher123</div>
<div><span class="role-badge role-student">å­¦ç”Ÿ</span> student / student123</div>
</div>
</div>
</div>
</div>

<div id="dashboardContainer" class="dashboard-container">
<div class="container">
<div class="header">
<h1>LMS-Edge æ•™å­¦ç®¡ç†ç³»ç»Ÿ</h1>
<div class="user-info">
<span id="welcomeUser">æ¬¢è¿å›æ¥</span>
<span id="lastActive" style="color:#999;font-size:12px"></span>
<button class="logout-btn" onclick="doLogout()">é€€å‡ºç™»å½•</button>
</div>
</div>

<div class="stats-row">
<div class="stat-card"><h3 id="statStudents">0</h3><p>å­¦ç”Ÿæ•°</p></div>
<div class="stat-card"><h3 id="statAssignments">0</h3><p>ä½œä¸šæ€»æ•°</p></div>
<div class="stat-card"><h3 id="statOnline">0</h3><p>åœ¨çº¿äººæ•°</p></div>
<div class="stat-card"><h3 id="statSessions">0</h3><p>å­¦ä¹ äººæ¬¡</p></div>
</div>

<div id="adminNav" class="nav-tabs" style="display:none">
<button class="active" onclick="showSection('users',this)">ç”¨æˆ·ç®¡ç†</button>
<button onclick="showSection('assignments',this)">ä½œä¸šç®¡ç†</button>
<button onclick="showSection('attendance',this)">è€ƒå‹¤è®°å½•</button>
<button onclick="showSection('whiteboard',this)">ç™½æ¿</button>
<button onclick="showSection('game',this)">ğŸ® æ¸¸æˆ</button>
<button onclick="showSection('logs',this)">æ“ä½œæ—¥å¿—</button>
</div>

<div id="teacherNav" class="nav-tabs" style="display:none">
<button onclick="showSection('attendance',this)">è€ƒå‹¤è®°å½•</button>
<button onclick="showSection('assignments',this)">ä½œä¸šç®¡ç†</button>
<button onclick="showSection('whiteboard',this)">ç™½æ¿</button>
<button onclick="showSection('game',this)">ğŸ® æ¸¸æˆ</button>
</div>

<div id="studentNav" class="nav-tabs" style="display:none">
<button class="active" onclick="showSection('myAssignments',this)">æˆ‘çš„ä½œä¸š</button>
<button onclick="showSection('mySubmissions',this)">æˆ‘çš„ä½œç­”</button>
<button onclick="showSection('whiteboard',this)">ç™½æ¿</button>
<button onclick="showSection('game',this)">ğŸ® æ¸¸æˆ</button>
</div>

<div id="usersSection" class="content-section active">
<h3 style="margin-bottom:15px">ç”¨æˆ·ç®¡ç†</h3>
<div class="filter-bar">
<button class="btn btn-primary btn-sm" onclick="showUserModal()">æ–°å¢ç”¨æˆ·</button>
<input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·å..." onkeyup="loadUsers()">
<select id="roleFilter" onchange="loadUsers()">
<option value="">å…¨éƒ¨è§’è‰²</option>
<option value="admin">ç®¡ç†å‘˜</option>
<option value="teacher">è€å¸ˆ</option>
<option value="student">å­¦ç”Ÿ</option>
</select>
</div>
<table id="usersTable">
<thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>å§“å</th><th>è§’è‰²</th><th>çŠ¶æ€</th><th>æœ€åæ´»è·ƒ</th><th>æ“ä½œ</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div id="assignmentsSection" class="content-section">
<h3 style="margin-bottom:15px">ä½œä¸šç®¡ç†</h3>
<div class="filter-bar">
<button class="btn btn-primary btn-sm" onclick="showAssignmentModal()">åˆ›å»ºä½œä¸š</button>
<input type="text" id="assignmentSearch" placeholder="æœç´¢ä½œä¸š..." onkeyup="loadAssignments()">
</div>
<table id="assignmentsTable">
<thead><tr><th>ID</th><th>æ ‡é¢˜</th><th>ç±»å‹</th><th>åˆ†å€¼</th><th>æäº¤æ•°</th><th>åˆ›å»ºè€…</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div id="attendanceSection" class="content-section">
<h3 style="margin-bottom:15px">è€ƒå‹¤è®°å½•</h3>
<div class="filter-bar">
<button class="btn btn-primary btn-sm" onclick="loadOnlineUsers()">åˆ·æ–°åœ¨çº¿çŠ¶æ€</button>
</div>
<div class="stats-row" style="margin-bottom:20px">
<div class="stat-card"><h3 id="onlineCount">0</h3><p>å½“å‰åœ¨çº¿</p></div>
</div>
<table id="attendanceTable">
<thead><tr><th>ç”¨æˆ·</th><th>è§’è‰²</th><th>ç™»å½•æ—¶é—´</th><th>æœ€åæ´»è·ƒ</th><th>æ—¶é•¿</th><th>çŠ¶æ€</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div id="whiteboardSection" class="content-section">
<h3 style="margin-bottom:15px">åä½œç™½æ¿</h3>
<div id="whiteboardTeacherControls" style="margin-bottom:10px;display:none">
<label><input type="checkbox" id="whiteboardAllowDraw" onchange="toggleWhiteboardDraw()"> å…è®¸å­¦ç”Ÿç»˜ç”»</label>
<span id="whiteboardOnline" style="margin-left:20px;color:#666;font-size:13px;"></span>
</div>
<div class="whiteboard-toolbar">
<button id="btnPen" class="active" onclick="setTool('pen')">âœï¸ ç”»ç¬”</button>
<button id="btnEraser" onclick="setTool('eraser')">ğŸ§¹ æ©¡çš®</button>
<button id="btnLine" onclick="setTool('line')">ğŸ“ ç›´çº¿</button>
<button id="btnRect" onclick="setTool('rect')">â¬œ çŸ©å½¢</button>
<button id="btnCircle" onclick="setTool('circle')">â­• åœ†å½¢</button>
<input type="color" id="colorPicker" value="#000000" style="width:40px;height:35px;cursor:pointer;border:none;border-radius:5px;">
<button onclick="setLineWidth(2)">ç»†</button>
<button onclick="setLineWidth(5)">ä¸­</button>
<button onclick="setLineWidth(10)">ç²—</button>
<button onclick="clearWhiteboard()" style="margin-left:auto;">ğŸ—‘ï¸ æ¸…ç©º</button>
</div>
<div style="position:relative;background:white;border-radius:8px;overflow:hidden;">
<canvas id="whiteboardCanvas" style="width:100%;height:500px;display:block;"></canvas>
<div id="whiteboardOverlay" style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.3);color:white;font-size:18px;font-weight:bold;">ç­‰å¾…è€å¸ˆå¼€å¯...</div>
</div>
<div id="whiteboardStatus" style="margin-top:10px;color:#666;font-size:13px;display:flex;justify-content:space-between;">
<span>ğŸ–±ï¸ å·¦é”®ç»˜ç”» | ğŸ–±ï¸ å³é”®æ‹–åŠ¨</span>
<span id="syncStatus"></span>
</div>
</div>

<div id="gameSection" class="content-section">
<h3 style="margin-bottom:15px">ğŸ® å–œåˆ·åˆ·å¯¹æˆ˜</h3>
<div id="gameInfo" style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:15px">
<div style="display:flex;justify-content:space-between;margin-bottom:10px">
<span>ğŸ’° é‡‘å¸: <strong id="playerGold">0</strong></span>
<span>ğŸ–ï¸ å‹‹ç« : <strong id="playerMedals">0</strong></span>
<span>ğŸ‘¤ èƒœåœº: <strong id="playerWins">0</strong></span>
</div>
<div id="gameInventory" style="display:flex;gap:8px;flex-wrap:wrap"></div>
</div>
<div id="teacherGameArea" style="display:none">
<h4 style="margin-bottom:10px">ğŸ‘¨â€ğŸ« å­¦ç”Ÿæ¸¸æˆçŠ¶æ€</h4>
<div id="studentGameStatus" style="background:#f5f5f5;padding:15px;border-radius:8px">
<p style="color:#999;text-align:center">åŠ è½½ä¸­...</p>
</div>
</div>
<div id="studentGameArea">
<div id="gameMatchArea" style="text-align:center;padding:30px">
<div id="matchStatus" style="margin-bottom:20px;color:#666;font-size:14px">ç‚¹å‡»å¼€å§‹åŒ¹é…</div>
<button id="matchBtn" class="btn btn-primary" onclick="startMatch()" style="padding:15px 40px;font-size:16px">ğŸ® å¼€å§‹åŒ¹é…</button>
</div>
<div id="gamePlayArea" style="display:none">
<div id="gameBattleStage" style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:15px">
<div style="display:flex;justify-content:space-around;align-items:center">
<div id="gameHeroNode" style="text-align:center">
<div id="heroGameAvatar" style="font-size:50px">ğŸ§™â€â™€ï¸</div>
<div style="margin-top:5px;font-weight:bold">æˆ‘</div>
<div style="width:60px;height:6px;background:#eee;border-radius:3px;overflow:hidden;margin:5px auto">
<div id="heroGameHp" style="width:100%;height:100%;background:#55efc4;transition:width 0.3s"></div>
</div>
<div id="heroGameBuffs" style="font-size:16px"></div>
</div>
<div style="font-size:24px;color:#999">VS</div>
<div id="gameEnemyNode" style="text-align:center">
<div id="enemyGameAvatar" style="font-size:50px">ğŸ‘¾</div>
<div id="enemyGameName" style="margin-top:5px;font-weight:bold">å¯¹æ‰‹</div>
<div style="width:60px;height:6px;background:#eee;border-radius:3px;overflow:hidden;margin:5px auto">
<div id="enemyGameHp" style="width:100%;height:100%;background:#ff7675;transition:width 0.3s"></div>
</div>
</div>
</div>
<div id="gameMessage" style="text-align:center;margin:10px 0;font-size:13px;color:#667eea;font-weight:bold"></div>
</div>
<div id="gameQuizArea" style="background:white;padding:20px;border-radius:8px;border:1px solid #eee">
<div id="gameQType" style="display:inline-block;padding:2px 8px;background:#dfe6e9;border-radius:4px;font-size:11px;margin-bottom:8px">é¢˜å‹</div>
<div id="gameQText" style="font-size:16px;font-weight:bold;color:#333;margin-bottom:15px;line-height:1.4">é¢˜ç›®åŠ è½½ä¸­...</div>
<div id="gameOptions" style="display:grid;grid-gap:10px"></div>
<div id="gameActionBtns" style="margin-top:15px;text-align:center;display:none">
<button id="gameSubmitBtn" class="btn btn-primary" onclick="submitGameAnswer()">ç¡®è®¤æäº¤</button>
<button id="gameContinueBtn" class="btn" style="background:#55efc4;color:white" onclick="nextGameQuestion()">ç»§ç»­</button>
</div>
</div>
<button class="btn btn-danger" onclick="quitGame()" style="margin-top:15px;width:100%">è®¤è¾“é€€å‡º</button>
</div>
</div>
<div id="gameResultModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;justify-content:center;align-items:center">
<div style="background:white;padding:30px;border-radius:15px;text-align:center;max-width:350px">
<div id="resultEmoji" style="font-size:60px;margin-bottom:15px"></div>
<h2 id="resultTitle" style="margin-bottom:10px"></h2>
<p id="resultDesc" style="color:#666;margin-bottom:20px"></p>
<div id="resultRewards" style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px"></div>
<button class="btn btn-primary" onclick="closeGameResult()">è¿”å›æ¸¸æˆå¤§å…</button>
</div>
</div>
<h3 style="margin-top:30px;margin-bottom:15px">ğŸ† æ’è¡Œæ¦œ</h3>
<div id="gameLeaderboard" style="background:white;padding:15px;border-radius:8px">
<table style="width:100%;font-size:13px">
<thead><tr><th>æ’å</th><th>ç©å®¶</th><th>å‹‹ç« </th><th>èƒœåœº</th></tr></thead>
<tbody id="leaderboardBody"></tbody>
</table>
</div>
</div>

<div id="logsSection" class="content-section">
<h3 style="margin-bottom:15px">æ“ä½œæ—¥å¿—</h3>
<div id="logsList"></div>
</div>

<div id="myAssignmentsSection" class="content-section active">
<div class="stats-row">
<div class="stat-card"><h3 id="statTotalScore">0</h3><p>æ€»ç§¯åˆ†</p></div>
<div class="stat-card"><h3 id="statAvgScore">0</h3><p>å¹³å‡åˆ†</p></div>
<div class="stat-card"><h3 id="statCompleted">0</h3><p>å·²å®Œæˆ</p></div>
</div>
<h3 style="margin-bottom:15px">å¯ç”¨ä½œä¸š</h3>
<table id="myAssignmentsTable">
<thead><tr><th>ID</th><th>æ ‡é¢˜</th><th>ç±»å‹</th><th>åˆ†å€¼</th><th>é™„ä»¶</th><th>æ“ä½œ</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div id="mySubmissionsSection" class="content-section">
<h3 style="margin-bottom:15px">æˆ‘çš„ä½œç­”</h3>
<table id="mySubmissionsTable">
<thead><tr><th>ä½œä¸š</th><th>æˆ‘çš„ç­”æ¡ˆ</th><th>å¾—åˆ†</th><th>è¯„è¯­</th><th>é™„ä»¶</th><th>æäº¤æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>

<div id="userModal" class="modal-overlay">
<div class="modal">
<span class="close-btn" onclick="closeModal('userModal')">&times;</span>
<h2 id="userModalTitle">æ–°å¢ç”¨æˆ·</h2>
<div class="form-group">
<label>ç”¨æˆ·å *</label>
<input type="text" id="editUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
</div>
<div class="form-group">
<label>å§“å</label>
<input type="text" id="editFullName" placeholder="è¾“å…¥å§“å">
</div>
<div class="form-group">
<label>è§’è‰² *</label>
<select id="editRole">
<option value="student">å­¦ç”Ÿ</option>
<option value="teacher">è€å¸ˆ</option>
<option value="admin">ç®¡ç†å‘˜</option>
</select>
</div>
<div class="form-group" id="passwordGroup">
<label id="passwordLabel">åˆå§‹å¯†ç  *</label>
<input type="password" id="editPassword" placeholder="è¾“å…¥å¯†ç ">
</div>
<input type="hidden" id="editUserId">
<button class="btn btn-primary" style="width:100%" onclick="saveUser()">ä¿å­˜</button>
</div>
</div>

<div id="assignmentModal" class="modal-overlay">
<div class="modal">
<span class="close-btn" onclick="closeModal('assignmentModal')">&times;</span>
<h2 id="assignmentModalTitle">åˆ›å»ºä½œä¸š</h2>
<div class="form-group">
<label>ä½œä¸šæ ‡é¢˜ *</label>
<input type="text" id="assignTitle" placeholder="è¾“å…¥ä½œä¸šæ ‡é¢˜">
</div>
<div class="form-group">
<label>ä½œä¸šå†…å®¹</label>
<textarea id="assignContent" placeholder="è¾“å…¥ä½œä¸šè¯¦ç»†å†…å®¹..."></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>ä½œä¸šç±»å‹</label>
<select id="assignType" onchange="toggleAssignmentFields()">
<option value="single_choice">å•é€‰é¢˜</option>
<option value="multiple_choice">å¤šé€‰é¢˜</option>
<option value="programming">æœºè¯•é¢˜</option>
</select>
</div>
<div class="form-group">
<label>åˆ†å€¼</label>
<input type="number" id="assignPoints" value="10" min="1">
</div>
</div>
<div id="choiceFields">
<div class="form-group">
<label>é€‰é¡¹</label>
<div id="optionsList"></div>
<button class="btn btn-sm" onclick="addOption()" style="margin-top:5px">+ æ·»åŠ é€‰é¡¹</button>
</div>
<div class="form-group">
<label>æ­£ç¡®ç­”æ¡ˆ</label>
<input type="text" id="assignAnswer" placeholder="è¾“å…¥æ­£ç¡®ç­”æ¡ˆ">
</div>
</div>
<div id="programmingFields" style="display:none">
<div class="form-group">
<label>ä¸Šä¼ é™„ä»¶</label>
<div class="file-upload" onclick="document.getElementById('assignmentFile').click()">
<p>ç‚¹å‡»ä¸Šä¼ é™„ä»¶</p>
<p style="font-size:12px;color:#999">æ”¯æŒ: xlsx, xls, doc, docx, zip, rar, jpg, png</p>
<input type="file" id="assignmentFile" style="display:none" onchange="handleAssignmentFile(this)">
</div>
<ul id="attachmentList" class="file-list"></ul>
</div>
</div>
<input type="hidden" id="editAssignmentId">
<button class="btn btn-primary" style="width:100%" onclick="saveAssignment()">ä¿å­˜</button>
</div>
</div>

<div id="detailModal" class="modal-overlay">
<div class="modal" style="max-width:700px">
<span class="close-btn" onclick="closeModal('detailModal')">&times;</span>
<h2 id="detailModalTitle">ä½œä¸šè¯¦æƒ…</h2>
<div id="detailContent"></div>
</div>
</div>

<div id="submitModal" class="modal-overlay">
<div class="modal">
<span class="close-btn" onclick="closeModal('submitModal')">&times;</span>
<h2 id="submitModalTitle">æäº¤ä½œä¸š</h2>
<div id="submitAssignmentInfo" class="detail-view"></div>
<div id="submitChoiceFields">
<div class="form-group">
<label>æˆ‘çš„ç­”æ¡ˆ</label>
<div id="submitOptionsList"></div>
</div>
</div>
<div id="submitProgrammingFields" style="display:none">
<div class="form-group">
<label>ä¸Šä¼ ä½œç­”æ–‡ä»¶</label>
<div class="file-upload" onclick="document.getElementById('submissionFile').click()">
<p>ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</p>
<p style="font-size:12px;color:#999">æ”¯æŒ: zip, rar, jpg, png, pdf, doc, docx</p>
<input type="file" id="submissionFile" style="display:none" onchange="handleSubmissionFile(this)">
</div>
<ul id="submissionFileList" class="file-list"></ul>
</div>
</div>
<input type="hidden" id="submitAssignmentId">
<input type="hidden" id="currentSubmissionId">
<button class="btn btn-primary" style="width:100%" onclick="submitAssignment()">æäº¤</button>
</div>
</div>

<div id="gradeModal" class="modal-overlay">
<div class="modal">
<span class="close-btn" onclick="closeModal('gradeModal')">&times;</span>
<h2>æ‰¹æ”¹ä½œä¸š</h2>
<div class="form-group">
<label>å­¦ç”Ÿ</label>
<p id="gradeStudentName" style="margin:5px 0"></p>
</div>
<div class="form-group">
<label>ä½œç­”å†…å®¹</label>
<p id="gradeAnswer" style="margin:5px 0;color:#666"></p>
</div>
<div class="form-group">
<label>é™„ä»¶</label>
<p id="gradeAttachment" style="margin:5px 0"></p>
</div>
<div class="form-group">
<label>å¾—åˆ† <span id="gradeMaxPoints" style="color:#999;font-weight:normal"></span></label>
<input type="number" id="gradeScore" min="0" max="100" value="0">
</div>
<div class="form-group">
<label>è¯„è¯­</label>
<textarea id="gradeFeedback" rows="3" placeholder="è¾“å…¥è¯„è¯­"></textarea>
</div>
<input type="hidden" id="gradeSubmissionId">
<button class="btn btn-primary" style="width:100%" onclick="gradeSubmission()">ä¿å­˜è¯„åˆ†</button>
</div>
</div>

<div id="passwordModal" class="modal-overlay">
<div class="modal">
<span class="close-btn" onclick="closeModal('passwordModal')">&times;</span>
<h2>ä¿®æ”¹å¯†ç </h2>
<div class="form-group">
<label>åŸå¯†ç </label>
<input type="password" id="oldPassword" placeholder="è¾“å…¥åŸå¯†ç ">
</div>
<div class="form-group">
<label>æ–°å¯†ç </label>
<input type="password" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ">
</div>
<div class="form-group">
<label>ç¡®è®¤æ–°å¯†ç </label>
<input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
</div>
<button class="btn btn-primary" style="width:100%" onclick="changePassword()">ç¡®è®¤ä¿®æ”¹</button>
</div>
</div>

<script>
var API_URL = window.location.origin;
var currentUser = null;
var SESSION_TIMEOUT = 24 * 60 * 60 * 1000;
var sessionTimer = null;
var currentAssignmentFile = null;
var currentSubmissionFile = null;
var sessionEventHandler = null;

function getSession() {
    var session = localStorage.getItem('lms_session');
    if (session) {
        try {
            var data = JSON.parse(session);
            if (data && data.user && data.loginTime) {
                var now = Date.now();
                if (now - data.loginTime < SESSION_TIMEOUT) {
                    return data;
                }
            }
            localStorage.removeItem('lms_session');
        } catch (e) {
            localStorage.removeItem('lms_session');
        }
    }
    return null;
}

function saveSession(user, token) {
    var session = {user: user, token: token, loginTime: Date.now()};
    localStorage.setItem('lms_session', JSON.stringify(session));
    setupSessionTimer();
}

function setupSessionTimer() {
    if (sessionTimer) {
        clearTimeout(sessionTimer);
    }
    sessionTimer = setTimeout(function() {
        forceLogout();
    }, SESSION_TIMEOUT);
}

function forceLogout() {
    localStorage.removeItem('lms_session');
    currentUser = null;
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('dashboardContainer').style.display = 'none';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    removeSessionListeners();
    alert('ç™»å½•å·²è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•');
}

function addSessionListeners() {
    removeSessionListeners();
    sessionEventHandler = function() {
        setupSessionTimer();
    };
    document.addEventListener('click', sessionEventHandler);
    document.addEventListener('keypress', sessionEventHandler);
}

function removeSessionListeners() {
    if (sessionEventHandler) {
        document.removeEventListener('click', sessionEventHandler);
        document.removeEventListener('keypress', sessionEventHandler);
        sessionEventHandler = null;
    }
}

function initSession() {
    var session = getSession();
    if (session && session.user) {
        currentUser = session.user;
        showDashboard();
        setupSessionTimer();
        addSessionListeners();
    }
}

async function doLogin() {
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;
    if (!username || !password) {alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');return;}
    try {
        var res = await fetch(API_URL + '/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: username, password: password})
        });
        var data = await res.json();
        if (data.token) {
            currentUser = data.user;
            saveSession(data.user, data.token);
            showDashboard();
        } else {
            alert(data.error || 'ç™»å½•å¤±è´¥');
        }
    } catch (e) {
        alert('è¿æ¥å¤±è´¥: ' + e.message);
    }
}

function doLogout() {
    localStorage.removeItem('lms_session');
    currentUser = null;
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('dashboardContainer').style.display = 'none';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    if (sessionTimer) {
        clearTimeout(sessionTimer);
        sessionTimer = null;
    }
    removeSessionListeners();
}

function showDashboard() {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'block';
    document.getElementById('welcomeUser').textContent = 'æ¬¢è¿, ' + (currentUser.full_name || currentUser.username) + ' (' + getRoleName(currentUser.role) + ')';
    document.getElementById('adminNav').style.display = currentUser.role === 'admin' ? 'flex' : 'none';
    document.getElementById('teacherNav').style.display = currentUser.role === 'teacher' ? 'flex' : 'none';
    document.getElementById('studentNav').style.display = currentUser.role === 'student' ? 'flex' : 'none';
    loadAllStats();
    var firstSection = currentUser.role === 'student' ? 'myAssignments' : (currentUser.role === 'teacher' ? 'attendance' : 'users');
    showSection(firstSection, null);
    if (currentUser.role === 'student') autoSignin();
}

function getRoleName(role) {
    var names = {admin: 'ç®¡ç†å‘˜', teacher: 'è€å¸ˆ', student: 'å­¦ç”Ÿ'};
    return names[role] || role;
}

function showSection(section, btn) {
    document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-tabs button').forEach(el => el.classList.remove('active'));
    if (btn) btn.classList.add('active');
    var sectionMap = {
        'users': 'usersSection', 'assignments': 'assignmentsSection', 'attendance': 'attendanceSection',
        'whiteboard': 'whiteboardSection', 'logs': 'logsSection', 'game': 'gameSection',
        'myAssignments': 'myAssignmentsSection', 'mySubmissions': 'mySubmissionsSection'
    };
    var el = document.getElementById(sectionMap[section]);
    if (el) el.classList.add('active');
    if (section === 'users') loadUsers();
    if (section === 'assignments') loadAssignments();
    if (section === 'attendance') { loadAttendanceRecords(); loadOnlineUsers(); }
    if (section === 'stats') loadClassStats();
    if (section === 'logs') loadLogs();
    if (section === 'whiteboard') initWhiteboard();
    if (section === 'game') initGame();
    if (section !== 'game') {
        if (gamePollTimer) clearTimeout(gamePollTimer);
        if (gameHeartbeatTimer) clearInterval(gameHeartbeatTimer);
        gameState.inGame = false;
        gameState.inMatching = false;
    }
    if (section === 'myAssignments') { loadMyAssignments(); loadMyStats(); }
    if (section === 'mySubmissions') loadMySubmissions();
}

async function loadAllStats() {
    try {
        var res = await fetch(API_URL + '/api/info?role=' + currentUser.role);
        var data = await res.json();
        document.getElementById('statStudents').textContent = data.students || 0;
        document.getElementById('statAssignments').textContent = data.assignments || 0;
        document.getElementById('statSessions').textContent = data.students || 0;
    } catch (e) {console.error(e);}
}

async function loadMyStats() {
    if (!currentUser || currentUser.role !== 'student') return;
    try {
        var res = await fetch(API_URL + '/api/stats/my?user_id=' + currentUser.id);
        var data = await res.json();
        document.getElementById('statTotalScore').textContent = data.total_score || 0;
        document.getElementById('statAvgScore').textContent = data.avg_score || 0;
        document.getElementById('statCompleted').textContent = data.total_assignments || 0;
    } catch (e) {console.error(e);}
}

async function loadUsers() {
    try {
        var res = await fetch(API_URL + '/api/users');
        var data = await res.json();
        var tbody = document.querySelector('#usersTable tbody');
        var html = '';
        var search = document.getElementById('userSearch').value.toLowerCase();
        var roleFilter = document.getElementById('roleFilter').value;
        for (var u of (data.users || [])) {
            if (search && !u.username.toLowerCase().includes(search) && !(u.full_name || '').toLowerCase().includes(search)) continue;
            if (roleFilter && u.role !== roleFilter) continue;
            var isOnline = u.last_active && new Date(u.last_active) > new Date(Date.now() - 5*60*1000);
            var lastActive = u.last_active ? new Date(u.last_active).toLocaleString() : '-';
            html += '<tr><td>' + u.id + '</td><td>' + u.username + '</td><td>' + (u.full_name || '-') + '</td><td><span class="role-badge role-' + u.role + '">' + getRoleName(u.role) + '</span></td><td><span class="' + (isOnline ? 'online-badge' : 'offline-badge') + '">' + (isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿') + '</span></td><td>' + lastActive + '</td><td class="action-btns">';
            if (currentUser.role === 'admin') {
                html += '<button class="btn btn-primary btn-sm" onclick="editUser(' + u.id + ',\'' + u.username + '\',\'' + (u.full_name || '') + '\',\'' + u.role + '\')">ç¼–è¾‘</button>';
                if (u.id !== 1) {
                    html += '<button class="btn btn-danger btn-sm" onclick="deleteUser(' + u.id + ',\'' + u.username + '\')">åˆ é™¤</button>';
                }
            }
            html += '</td></tr>';
        }
        tbody.innerHTML = html || '<tr><td colspan="7" class="empty-message">æš‚æ— ç”¨æˆ·</td></tr>';
    } catch (e) {console.error(e);}
}

function showUserModal(id, username, fullName, role) {
    document.getElementById('userModalTitle').textContent = id ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ–°å¢ç”¨æˆ·';
    document.getElementById('editUserId').value = id || '';
    document.getElementById('editUsername').value = username || '';
    document.getElementById('editFullName').value = fullName || '';
    document.getElementById('editRole').value = role || 'student';
    document.getElementById('editPassword').value = '';
    document.getElementById('passwordLabel').textContent = id ? 'æ–°å¯†ç  (ç•™ç©ºä¸ä¿®æ”¹)' : 'åˆå§‹å¯†ç  *';
    document.getElementById('userModal').classList.add('active');
}

function editUser(id, username, fullName, role) {
    if (role === 'admin' && id !== 1 && currentUser.role !== 'admin') {
        alert('ä¸èƒ½ç¼–è¾‘ç®¡ç†å‘˜è´¦æˆ·');return;
    }
    showUserModal(id, username, fullName, role);
}

async function saveUser() {
    var id = document.getElementById('editUserId').value;
    var username = document.getElementById('editUsername').value;
    var fullName = document.getElementById('editFullName').value;
    var role = document.getElementById('editRole').value;
    var password = document.getElementById('editPassword').value;
    
    if (!username) {alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');return;}
    if (!id && !password) {alert('åˆå§‹å¯†ç ä¸èƒ½ä¸ºç©º');return;}
    
    var data = {username: username, full_name: fullName, role: role};
    if (password) data.password = password;
    if (id) data.id = parseInt(id);
    
    try {
        var url = id ? API_URL + '/api/users/' : API_URL + '/api/users/create';
        var method = id ? 'PUT' : 'POST';
        var res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        var result = await res.json();
        if (res.ok && (result.success || result.id)) {
            closeModal('userModal');
            loadUsers();
        } else {
            alert(result.error || 'æ“ä½œå¤±è´¥');
        }
    } catch (e) {alert('æ“ä½œå¤±è´¥: ' + e.message);}
}

async function deleteUser(id, username) {
    if (id === 1) {alert('ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦æˆ·');return;}
    if (!confirm('ç¡®å®šåˆ é™¤ç”¨æˆ· "' + username + '"ï¼Ÿ')) return;
    try {
        var res = await fetch(API_URL + '/api/users/' + id, {method: 'DELETE'});
        var data = await res.json();
        if (data.success) {loadUsers();} else {alert(data.error || 'åˆ é™¤å¤±è´¥');}
    } catch (e) {alert('åˆ é™¤å¤±è´¥: ' + e.message);}
}

async function loadAssignments() {
    try {
        var res = await fetch(API_URL + '/api/assignments/all');
        var data = await res.json();
        var tbody = document.querySelector('#assignmentsTable tbody');
        var html = '';
        var search = document.getElementById('assignmentSearch').value.toLowerCase();
        if (data.assignments && data.assignments.length > 0) {
            for (var a of data.assignments) {
                if (search && !a.title.toLowerCase().includes(search)) continue;
                var typeName = a.assignment_type === 'single_choice' ? 'å•é€‰' : (a.assignment_type === 'multiple_choice' ? 'å¤šé€‰' : 'æœºè¯•');
                html += '<tr><td>' + a.id + '</td><td><a href="javascript:void(0)" onclick="viewAssignmentDetail(' + a.id + ',\'' + a.title + '\')">' + a.title + '</a></td><td>' + typeName + '</td><td>' + a.points + '</td><td>' + (a.submission_count || 0) + '</td><td>' + (a.creator_name || 'æœªçŸ¥') + '</td><td>' + new Date(a.created_at).toLocaleString() + '</td><td class="action-btns">';
                if (currentUser.role === 'admin' || currentUser.role === 'teacher') {
                    html += '<button class="btn btn-primary btn-sm" onclick="editAssignment(' + a.id + ',\'' + a.title + '\',\'' + (a.content || '').replace(/'/g, "\\'") + '\',\'' + a.assignment_type + '\',' + a.points + ',\'' + (a.correct_answer || '') + '\')">ç¼–è¾‘</button>';
                    html += '<button class="btn btn-danger btn-sm" onclick="deleteAssignment(' + a.id + ',\'' + a.title + '\')">åˆ é™¤</button>';
                }
                html += '</td></tr>';
            }
        } else {
            html = '<tr><td colspan="8" class="empty-message">æš‚æ— ä½œä¸š</td></tr>';
        }
        tbody.innerHTML = html;
    } catch (e) {console.error(e);}
}

function showAssignmentModal(id, title, content, type, points, answer) {
    document.getElementById('assignmentModalTitle').textContent = id ? 'ç¼–è¾‘ä½œä¸š' : 'åˆ›å»ºä½œä¸š';
    document.getElementById('editAssignmentId').value = id || '';
    document.getElementById('assignTitle').value = title || '';
    document.getElementById('assignContent').value = content || '';
    document.getElementById('assignType').value = type || 'single_choice';
    document.getElementById('assignPoints').value = points || 10;
    document.getElementById('assignAnswer').value = answer || '';
    document.getElementById('attachmentList').innerHTML = '';
    document.getElementById('assignmentFile').value = '';
    currentAssignmentFile = null;
    toggleAssignmentFields();
    document.getElementById('assignmentModal').classList.add('active');
}

function editAssignment(id, title, content, type, points, answer) {
    showAssignmentModal(id, title, content, type, points, answer);
}

function toggleAssignmentFields() {
    var type = document.getElementById('assignType').value;
    document.getElementById('choiceFields').style.display = (type === 'single_choice' || type === 'multiple_choice') ? 'block' : 'none';
    document.getElementById('programmingFields').style.display = type === 'programming' ? 'block' : 'none';
    if (type === 'single_choice') {
        document.getElementById('assignAnswer').placeholder = 'è¾“å…¥æ­£ç¡®é€‰é¡¹åºå·ï¼Œå¦‚ A';
    } else if (type === 'multiple_choice') {
        document.getElementById('assignAnswer').placeholder = 'è¾“å…¥æ­£ç¡®é€‰é¡¹ï¼Œå¦‚ AB';
    } else {
        document.getElementById('assignAnswer').placeholder = '';
    }
}

function addOption() {
    var list = document.getElementById('optionsList');
    var idx = list.children.length;
    var div = document.createElement('div');
    div.className = 'option-item';
    div.innerHTML = '<span style="width:30px">' + String.fromCharCode(65 + idx) + '</span><input type="text" placeholder="é€‰é¡¹å†…å®¹"><button onclick="this.parentElement.remove()">åˆ é™¤</button>';
    list.appendChild(div);
}

function handleAssignmentFile(input) {
    if (input.files[0]) {
        currentAssignmentFile = input.files[0];
        var list = document.getElementById('attachmentList');
        list.innerHTML = '<li><span class="file-icon">ğŸ“</span>' + currentAssignmentFile.name + '</li>';
    }
}

async function saveAssignment() {
    var id = document.getElementById('editAssignmentId').value;
    var title = document.getElementById('assignTitle').value;
    var content = document.getElementById('assignContent').value;
    var type = document.getElementById('assignType').value;
    var points = parseInt(document.getElementById('assignPoints').value) || 10;
    var answer = document.getElementById('assignAnswer').value;
    
    if (!title) {alert('ä½œä¸šæ ‡é¢˜ä¸èƒ½ä¸ºç©º');return;}
    
    var data = {title: title, content: content, assignment_type: type, points: points};
    
    if (type === 'single_choice' || type === 'multiple_choice') {
        var options = [];
        document.querySelectorAll('#optionsList input').forEach(function(input) {
            if (input.value) options.push(input.value);
        });
        data.options = options;
        data.correct_answer = answer;
    }
    
    try {
        var url = id ? API_URL + '/api/assignments/' + id : API_URL + '/api/assignments/create';
        var method = id ? 'PUT' : 'POST';
        if (!id) data.created_by = currentUser.id;
        
        var res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        var result = await res.json();
        
        if (result.success || result.id) {
            var assignmentId = result.id || id;
            if (currentAssignmentFile) {
                try {
                    var formData = new FormData();
                    formData.append('file', currentAssignmentFile);
                    var uploadRes = await fetch(API_URL + '/api/attachments/' + assignmentId, {method: 'POST', body: formData});
                    var uploadResult = await uploadRes.json();
                    if (!uploadResult.success) {
                        alert('é™„ä»¶ä¸Šä¼ å¤±è´¥: ' + (uploadResult.error || 'æœªçŸ¥é”™è¯¯'));
                        return;
                    }
                } catch (e) {
                    alert('é™„ä»¶ä¸Šä¼ å¤±è´¥: ' + e.message);
                    return;
                }
            }
            closeModal('assignmentModal');
            loadAssignments();
        } else {
            alert(result.error || 'æ“ä½œå¤±è´¥');
        }
    } catch (e) {alert('æ“ä½œå¤±è´¥: ' + e.message);}
}

async function deleteAssignment(id, title) {
    if (!confirm('ç¡®å®šåˆ é™¤ä½œä¸š "' + title + '"ï¼Ÿ')) return;
    try {
        var res = await fetch(API_URL + '/api/assignments/' + id, {method: 'DELETE'});
        var data = await res.json();
        if (data.success) {loadAssignments();} else {alert(data.error || 'åˆ é™¤å¤±è´¥');}
    } catch (e) {alert('åˆ é™¤å¤±è´¥: ' + e.message);}
}

async function viewAssignmentDetail(id, title) {
    try {
        var res = await fetch(API_URL + '/api/assignments/' + id);
        var data = await res.json();
        var assignmentType = data.assignment.assignment_type;
        var isAutoGrade = assignmentType === 'single_choice' || assignmentType === 'multiple_choice';
        var html = '<div class="detail-view"><h4>' + data.assignment.title + '</h4><p><strong>å†…å®¹:</strong> ' + (data.assignment.content || 'æ— ') + '</p><p><strong>ç±»å‹:</strong> ' + (assignmentType === 'single_choice' ? 'å•é€‰' : (assignmentType === 'multiple_choice' ? 'å¤šé€‰' : 'æœºè¯•')) + (isAutoGrade ? ' (è‡ªåŠ¨æ‰¹æ”¹)' : '') + '</p><p><strong>åˆ†å€¼:</strong> ' + data.assignment.points + '</p></div>';
        if (data.assignment.attachment) {
            html += '<div class="form-group"><label>é™„ä»¶:</label><a href="' + API_URL + '/api/attachments/' + data.assignment.id + '/' + data.assignment.attachment + '" target="_blank" class="btn btn-sm btn-primary">ä¸‹è½½é™„ä»¶</a></div>';
        }
        html += '<h4 style="margin-top:15px">å­¦ç”Ÿä½œç­” (' + (data.assignment.submissions || []).length + ')</h4>';
        if (data.assignment.submissions && data.assignment.submissions.length > 0) {
            html += '<table style="font-size:13px"><thead><tr><th>å­¦ç”Ÿ</th><th>ç­”æ¡ˆ</th><th>å¾—åˆ†</th><th>è¯„è¯­</th><th>é™„ä»¶</th><th>æäº¤æ—¶é—´</th><th>æ‰¹æ”¹</th></tr></thead><tbody>';
            for (var s of data.assignment.submissions) {
                var attachmentLink = s.attachment ? '<a href="' + API_URL + '/api/submissions/file/' + s.id + '/' + s.attachment + '" target="_blank">ä¸‹è½½</a>' : '-';
                var isGraded = isAutoGrade || (s.score !== undefined && s.score >= 0) || s.feedback;
                var scoreDisplay = isGraded ? s.score + 'åˆ†' : 'å¾…æ‰¹æ”¹';
                var feedbackDisplay = s.feedback || (isAutoGrade ? (s.is_correct ? 'æ­£ç¡®' : 'é”™è¯¯') : '-');
                var feedbackEscaped = (s.feedback || '').replace(/'/g, "\\'");
                var gradeBtnText = isGraded ? 'é‡æ–°æ‰¹æ”¹' : 'æ‰¹æ”¹';
                var gradeBtn = '<button class="btn btn-sm btn-primary" onclick="showGradeModal(' + s.id + ',\'' + (s.full_name || s.username) + '\',' + (s.score || 0) + ',\'' + feedbackEscaped + '\')">' + gradeBtnText + '</button>';
                html += '<tr><td>' + (s.full_name || s.username) + '</td><td>' + (s.student_answer || '-') + '</td><td>' + scoreDisplay + '</td><td>' + feedbackDisplay + '</td><td>' + attachmentLink + '</td><td>' + new Date(s.submitted_at).toLocaleString() + '</td><td>' + gradeBtn + '</td></tr>';
            }
            html += '</tbody></table>';
        } else {
            html += '<p class="empty-message">æš‚æ— ä½œç­”</p>';
        }
        document.getElementById('detailModalTitle').textContent = 'ä½œä¸šè¯¦æƒ… - ' + title;
        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailModal').dataset.assignmentId = id;
        document.getElementById('detailModal').classList.add('active');
    } catch (e) {alert('è·å–è¯¦æƒ…å¤±è´¥: ' + e.message);}
}

async function loadMyAssignments() {
    try {
        var res = await fetch(API_URL + '/api/assignments?user_id=' + currentUser.id);
        var data = await res.json();
        var tbody = document.querySelector('#myAssignmentsTable tbody');
        var html = '';
        if (data.assignments && data.assignments.length > 0) {
            for (var a of data.assignments) {
                var typeName = a.assignment_type === 'single_choice' ? 'å•é€‰' : (a.assignment_type === 'multiple_choice' ? 'å¤šé€‰' : 'æœºè¯•');
                var attachmentLink = a.attachment ? '<a href="' + API_URL + '/api/attachments/' + a.id + '/' + a.attachment + '" target="_blank">ğŸ“ä¸‹è½½</a>' : '-';
                var mySub = a.my_submission;
                var isGraded = mySub && ((mySub.score !== undefined && mySub.score > 0) || mySub.feedback);
                var btnHtml = '';
                if (mySub) {
                    var btnClass = isGraded ? 'btn-secondary' : 'btn-info';
                    var btnText = isGraded ? 'å·²æ‰¹æ”¹' : 'å·²ä½œç­”';
                    btnHtml = '<span class="' + btnClass + ' btn-sm" style="padding:4px 8px;font-size:12px;display:inline-block;cursor:not-allowed;" title="ä½œç­”åä¸å¯ä¿®æ”¹">' + btnText + '</span>';
                } else {
                    btnHtml = '<button class="btn btn-success btn-sm" onclick="showSubmitModal(' + a.id + ',\'' + a.title + '\')">ä½œç­”</button>';
                }
                html += '<tr><td>' + a.id + '</td><td>' + a.title + '</td><td>' + typeName + '</td><td>' + a.points + '</td><td>' + attachmentLink + '</td><td>' + btnHtml + '</td></tr>';
            }
        } else {
            html = '<tr><td colspan="6" class="empty-message">æš‚æ— ä½œä¸š</td></tr>';
        }
        tbody.innerHTML = html;
    } catch (e) {console.error(e);}
}

async function showSubmitModal(id, title) {
    try {
        var res = await fetch(API_URL + '/api/assignments/' + id);
        var data = await res.json();
        var a = data.assignment;
        var existingSubmission = data.assignment.submissions && data.assignment.submissions[0];
        var isGraded = existingSubmission && ((existingSubmission.score !== undefined && existingSubmission.score > 0) || existingSubmission.feedback);
        
        document.getElementById('submitAssignmentId').value = id;
        document.getElementById('currentSubmissionId').value = existingSubmission ? existingSubmission.id : '';
        document.getElementById('submitModalTitle').textContent = 'æäº¤ - ' + title;
        document.getElementById('submissionFileList').innerHTML = '';
        document.getElementById('submissionFile').value = '';
        currentSubmissionFile = null;
        
        var typeName = a.assignment_type === 'single_choice' ? 'å•é€‰' : (a.assignment_type === 'multiple_choice' ? 'å¤šé€‰' : 'æœºè¯•');
        var attachmentInfo = a.attachment ? '<p><a href="' + API_URL + '/api/attachments/' + a.id + '/' + a.attachment + '" target="_blank">ğŸ“ä¸‹è½½é™„ä»¶: ' + a.attachment + '</a></p>' : '';
        document.getElementById('submitAssignmentInfo').innerHTML = '<p><strong>æ ‡é¢˜:</strong> ' + a.title + '</p><p><strong>ç±»å‹:</strong> ' + typeName + '</p><p><strong>åˆ†å€¼:</strong> ' + a.points + '</p><p><strong>å†…å®¹:</strong> ' + (a.content || 'æ— ') + '</p>' + attachmentInfo;
        
        document.getElementById('submitChoiceFields').style.display = (a.assignment_type === 'single_choice' || a.assignment_type === 'multiple_choice') ? 'block' : 'none';
        document.getElementById('submitProgrammingFields').style.display = a.assignment_type === 'programming' ? 'block' : 'none';
        
        if (isGraded) {
            document.getElementById('submitOptionsList').innerHTML = '<p class="text-muted">æ­¤é¢˜å·²æ‰¹æ”¹ï¼Œä¸å¯ä¿®æ”¹</p>';
            document.getElementById('submitProgrammingFields').innerHTML = '<p class="text-muted">æ­¤é¢˜å·²æ‰¹æ”¹ï¼Œä¸å¯ä¿®æ”¹</p>';
            document.getElementById('submitProgrammingFields').innerHTML += '<p><strong>æˆ‘çš„ç­”æ¡ˆ:</strong> ' + (existingSubmission.student_answer || '(æ— )') + '</p>';
            if (existingSubmission.attachment) {
                document.getElementById('submitProgrammingFields').innerHTML += '<p><strong>æˆ‘çš„é™„ä»¶:</strong> <a href="' + API_URL + '/api/submissions/file/' + existingSubmission.id + '/' + existingSubmission.attachment + '" target="_blank">ğŸ“ ' + existingSubmission.attachment + '</a></p>';
            }
            var submitBtn = document.querySelector('#submitModal .btn-primary');
            if (submitBtn) {submitBtn.style.display = 'none';}
        } else if (a.assignment_type === 'single_choice' || a.assignment_type === 'multiple_choice') {
            var options = a.options ? JSON.parse(a.options) : [];
            var html = '';
            for (var i = 0; i < options.length; i++) {
                var optLetter = String.fromCharCode(65 + i);
                var isChecked = existingSubmission && existingSubmission.student_answer === optLetter;
                html += '<div class="option-item"><input type="radio" name="submitAnswer" id="opt_' + optLetter + '" value="' + optLetter + '" ' + (isChecked ? 'checked' : '') + '><label for="opt_' + optLetter + '">' + optLetter + '. ' + options[i] + '</label></div>';
            }
            if (a.assignment_type === 'multiple_choice') {
                html = html.replace(/radio/gi, 'checkbox');
            }
            document.getElementById('submitOptionsList').innerHTML = html || '<p>æ— é€‰é¡¹</p>';
            var submitBtn = document.querySelector('#submitModal .btn-primary');
            if (submitBtn) {submitBtn.style.display = 'block';submitBtn.textContent = existingSubmission ? 'æ›´æ–°ç­”æ¡ˆ' : 'æäº¤';}
        } else {
            var submitBtn = document.querySelector('#submitModal .btn-primary');
            if (submitBtn) {submitBtn.style.display = 'block';submitBtn.textContent = existingSubmission ? 'æ›´æ–°ç­”æ¡ˆ' : 'æäº¤';}
        }
        
        document.getElementById('submitModal').classList.add('active');
    } catch (e) {alert('è·å–ä½œä¸šå¤±è´¥: ' + e.message);}
}

function handleSubmissionFile(input) {
    if (input.files[0]) {
        currentSubmissionFile = input.files[0];
        var list = document.getElementById('submissionFileList');
        list.innerHTML = '<li><span class="file-icon">ğŸ“</span>' + currentSubmissionFile.name + '</li>';
    }
}

async function submitAssignment() {
    var assignmentId = document.getElementById('submitAssignmentId').value;
    var submissionId = document.getElementById('currentSubmissionId').value;
    var type = document.querySelector('#submitChoiceFields').style.display !== 'none' ? 'choice' : 'programming';
    var answer = '';
    
    if (type === 'choice') {
        var isMultiple = document.querySelector('input[name="submitAnswer"]') && document.querySelector('input[name="submitAnswer"]').type === 'checkbox';
        if (isMultiple) {
            var selected = document.querySelectorAll('input[name="submitAnswer"]:checked');
            answer = Array.from(selected).map(cb => cb.value).join(',');
        } else {
            var sel = document.querySelector('input[name="submitAnswer"]:checked');
            answer = sel ? sel.value : '';
        }
        if (!answer) {alert('è¯·é€‰æ‹©ç­”æ¡ˆ');return;}
    }
    
    var data = {user_id: currentUser.id, assignment_id: parseInt(assignmentId), answer: answer};
    
    try {
        var res = await fetch(API_URL + '/api/assignments/submit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        var result = await res.json();
        
        if (result.success) {
            var actualSubmissionId = submissionId || result.submission_id;
            if (currentSubmissionFile && actualSubmissionId) {
                var formData = new FormData();
                formData.append('file', currentSubmissionFile);
                await fetch(API_URL + '/api/submissions/file/' + actualSubmissionId, {method: 'POST', body: formData});
            }
            if (result.message) {
                alert(result.message);
            } else {
                alert('æäº¤æˆåŠŸï¼å¾—åˆ†: ' + (result.score || 0));
            }
            closeModal('submitModal');
            loadMyAssignments();
            loadMySubmissions();
            loadMyStats();
        } else {
            alert(result.error || 'æäº¤å¤±è´¥');
        }
    } catch (e) {alert('æäº¤å¤±è´¥: ' + e.message);}
}

function showGradeModal(submissionId, studentName, currentScore, feedback) {
    document.getElementById('gradeSubmissionId').value = submissionId;
    document.getElementById('gradeStudentName').textContent = studentName;
    document.getElementById('gradeScore').value = currentScore || 0;
    document.getElementById('gradeFeedback').value = feedback || '';
    document.getElementById('gradeModal').classList.add('active');
    
    fetchSubmissionDetail(submissionId);
}

async function fetchSubmissionDetail(submissionId) {
    try {
        var res = await fetch(API_URL + '/api/submissions/' + submissionId);
        var data = await res.json();
        if (data.submission) {
            document.getElementById('gradeAnswer').textContent = data.submission.student_answer || '(æ— ä½œç­”å†…å®¹)';
            if (data.submission.attachment) {
                var studentName = data.submission.full_name || 'Student';
                var dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
                var originalExt = data.submission.attachment.split('.').pop();
                var downloadName = studentName + dateStr + '.' + originalExt;
                var attachmentLink = '<a href="' + API_URL + '/api/submissions/file/' + data.submission.id + '/' + data.submission.attachment + '" target="_blank" download="' + downloadName + '">ğŸ“ ' + data.submission.attachment + '</a>';
            } else {
                var attachmentLink = 'æ— ';
            }
            document.getElementById('gradeAttachment').innerHTML = attachmentLink;
        }
    } catch (e) {
        console.error('è·å–ä½œç­”è¯¦æƒ…å¤±è´¥:', e);
    }
}

async function gradeSubmission() {
    var submissionId = document.getElementById('gradeSubmissionId').value;
    var score = document.getElementById('gradeScore').value;
    var feedback = document.getElementById('gradeFeedback').value;
    
    if (!submissionId) {alert('ç¼ºå°‘ä½œç­”ID');return;}
    
    try {
        var res = await fetch(API_URL + '/api/submissions/' + submissionId + '/grade', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                score: parseFloat(score) || 0,
                feedback: feedback,
                teacher_id: currentUser.id
            })
        });
        var result = await res.json();
        if (result.success) {
            alert('æ‰¹æ”¹æˆåŠŸï¼');
            closeModal('gradeModal');
            viewAssignmentDetail(parseInt(document.getElementById('detailModal').dataset.assignmentId), document.getElementById('detailModalTitle').textContent.replace('ä½œä¸šè¯¦æƒ… - ', ''));
        } else {
            alert(result.error || 'æ‰¹æ”¹å¤±è´¥');
        }
    } catch (e) {alert('æ‰¹æ”¹å¤±è´¥: ' + e.message);}
}

async function loadMySubmissions() {
    try {
        var res = await fetch(API_URL + '/api/submissions/my?user_id=' + currentUser.id);
        var data = await res.json();
        var tbody = document.querySelector('#mySubmissionsTable tbody');
        var html = '';
        if (data.submissions && data.submissions.length > 0) {
            data.submissions.sort(function(a,b){return new Date(b.submitted_at) - new Date(a.submitted_at);});
            for (var s of data.submissions) {
                var assignmentTitle = s.assignment_title;
                var attachmentLink = s.attachment ? '<a href="' + API_URL + '/api/submissions/file/' + s.id + '/' + s.attachment + '" target="_blank">ğŸ“ä¸‹è½½</a>' : '-';
                var isGraded = s.score !== undefined && s.score >= 0;
                var actionBtns = isGraded 
                    ? '<span class="text-muted" style="color:#999;font-size:12px">å·²æ‰¹æ”¹ï¼Œä¸å¯ä¿®æ”¹</span>'
                    : '<button class="btn btn-primary btn-sm" onclick="reSubmit(' + s.assignment_id + ',\'' + assignmentTitle.replace(/'/g, "\\'") + '\')">ä¿®æ”¹</button><button class="btn btn-danger btn-sm" onclick="deleteMySubmission(' + s.id + ')">åˆ é™¤</button>';
                html += '<tr><td style="cursor:pointer;color:#3498db" onclick="viewMySubmissionDetail(' + s.assignment_id + ',\'' + assignmentTitle.replace(/'/g, "\\'") + '\')" title="ç‚¹å‡»æŸ¥çœ‹é¢˜ç›®">' + assignmentTitle + '</td><td>' + (s.student_answer || '-') + '</td><td>' + (s.score !== undefined ? s.score : '-') + '</td><td>' + (s.feedback || '-') + '</td><td>' + attachmentLink + '</td><td>' + new Date(s.submitted_at).toLocaleString() + '</td><td class="action-btns">' + actionBtns + '</td></tr>';
            }
        } else {
            html = '<tr><td colspan="7" class="empty-message">æš‚æ— ä½œç­”è®°å½•</td></tr>';
        }
        tbody.innerHTML = html;
    } catch (e) {console.error(e);}
}

async function viewMySubmissionDetail(assignmentId, title) {
    try {
        var res = await fetch(API_URL + '/api/submissions/my?user_id=' + currentUser.id);
        var data = await res.json();
        var submission = data.submissions.find(function(s) { return s.assignment_id === assignmentId; });
        if (!submission) return;
        
        var res2 = await fetch(API_URL + '/api/assignments/' + assignmentId);
        var assignment = (await res2.json()).assignment;
        
        var typeName = assignment.assignment_type === 'single_choice' ? 'å•é€‰é¢˜' : (assignment.assignment_type === 'multiple_choice' ? 'å¤šé€‰é¢˜' : 'æœºè¯•é¢˜');
        var html = '<div class="detail-view" style="padding:0;">';
        html += '<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;margin:-20px -20px 20px -20px;border-radius:8px 8px 0 0;">';
        html += '<h4 style="margin:0 0 10px 0;font-size:18px;">' + assignment.title + '</h4>';
        html += '<div style="display:flex;gap:15px;font-size:13px;opacity:0.9;">';
        html += '<span>ğŸ“ ' + typeName + '</span>';
        html += '<span>â­ ' + assignment.points + 'åˆ†</span>';
        html += '</div></div>';
        
        if (assignment.content) {
            html += '<div style="margin-bottom:20px;"><strong style="display:block;margin-bottom:8px;color:#333;">é¢˜ç›®å†…å®¹</strong><div style="background:#f8f9fa;padding:12px;border-radius:8px;color:#555;line-height:1.6;">' + assignment.content + '</div></div>';
        }
        
        var myAnswer = submission.student_answer || '(æœªä½œç­”)';
        var correctAnswer = assignment.correct_answer || '(æ— æ­£ç¡®ç­”æ¡ˆ)';
        var isCorrect = submission.is_correct === 1;
        
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">';
        html += '<div style="background:#e3f2fd;padding:15px;border-radius:8px;"><strong style="display:block;margin-bottom:8px;color:#1976d2;">æˆ‘çš„ç­”æ¡ˆ</strong><div style="font-size:16px;font-weight:bold;color:#1976d2;">' + myAnswer + '</div></div>';
        html += '<div style="background:#fff3e0;padding:15px;border-radius:8px;"><strong style="display:block;margin-bottom:8px;color:#f57c00;">æ­£ç¡®ç­”æ¡ˆ</strong><div style="font-size:16px;font-weight:bold;color:#f57c00;">' + correctAnswer + '</div></div></div>';
        
        if (assignment.assignment_type === 'single_choice' || assignment.assignment_type === 'multiple_choice') {
            var options = assignment.options ? JSON.parse(assignment.options) : [];
            if (options.length > 0) {
                html += '<div style="margin-bottom:20px;"><strong style="display:block;margin-bottom:12px;color:#333;">é€‰é¡¹è¯¦æƒ…</strong>';
                html += '<div style="display:grid;gap:8px;">';
                var answerSet = new Set((submission.student_answer || '').split(',').map(function(a){return a.trim();}).filter(function(a){return a;}));
                for (var i = 0; i < options.length; i++) {
                    var optLetter = String.fromCharCode(65 + i);
                    var isMyAnswer = answerSet.has(optLetter);
                    var isCorrectAnswer = (assignment.correct_answer || '').split(',').map(function(a){return a.trim();}).filter(function(a){return a;}).includes(optLetter);
                    var bgColor = '#f5f5f5';
                    var borderColor = '#e0e0e0';
                    var badge = '';
                    if (isMyAnswer && isCorrectAnswer) {
                        bgColor = '#c8e6c9';
                        borderColor = '#81c784';
                        badge = '<span style="background:#4caf50;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:8px;">æ­£ç¡®</span>';
                    } else if (isMyAnswer && !isCorrectAnswer) {
                        bgColor = '#ffcdd2';
                        borderColor = '#ef9a9a';
                        badge = '<span style="background:#f44336;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:8px;">é”™è¯¯</span>';
                    } else if (!isMyAnswer && isCorrectAnswer) {
                        bgColor = '#fff9c4';
                        borderColor = '#fff59d';
                        badge = '<span style="background:#ffc107;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:8px;">æ­£ç¡®ç­”æ¡ˆ</span>';
                    }
                    html += '<div style="background:' + bgColor + ';border:1px solid ' + borderColor + ';padding:12px 15px;border-radius:8px;display:flex;align-items:center;">';
                    html += '<span style="font-weight:bold;margin-right:10px;color:#333;">' + optLetter + '.</span>';
                    html += '<span style="flex:1;color:#333;">' + options[i] + '</span>';
                    html += badge;
                    html += '</div>';
                }
                html += '</div></div>';
            }
        }
        
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">';
        html += '<div style="background:' + (submission.score !== undefined ? '#e8f5e9' : '#fafafa') + ';padding:15px;border-radius:8px;"><strong style="display:block;margin-bottom:8px;color:#333;">å¾—åˆ†</strong><div style="font-size:20px;font-weight:bold;color:' + (submission.score !== undefined ? '#4caf50' : '#999') + ';">' + (submission.score !== undefined ? submission.score : 'å¾…æ‰¹æ”¹') + '</div></div>';
        html += '<div style="background:#f5f5f5;padding:15px;border-radius:8px;"><strong style="display:block;margin-bottom:8px;color:#333;">æäº¤æ—¶é—´</strong><div style="color:#666;">' + new Date(submission.submitted_at).toLocaleString() + '</div></div></div>';
        
        if (submission.feedback) {
            html += '<div style="background:#fff3e0;padding:15px;border-radius:8px;border-left:4px solid #ff9800;"><strong style="color:#ff9800;">è€å¸ˆè¯„è¯­</strong><p style="margin:8px 0 0 0;color:#666;line-height:1.6;">' + submission.feedback + '</p></div>';
        }
        
        if (submission.attachment) {
            html += '<div style="margin-top:20px;padding-top:15px;border-top:1px solid #eee;"><strong style="color:#333;">æˆ‘çš„é™„ä»¶</strong><p style="margin:8px 0 0 0;"><a href="' + API_URL + '/api/submissions/file/' + submission.id + '/' + submission.attachment + '" target="_blank" style="color:#1976d2;text-decoration:none;display:inline-flex;align-items:center;"><span style="font-size:18px;margin-right:5px;">ğŸ“</span>' + submission.attachment + '</a></p></div>';
        }
        
        html += '</div>';
        
        document.getElementById('detailModalTitle').innerHTML = '<span style="font-weight:normal;font-size:14px;">ç­”é¢˜è¯¦æƒ…</span>';
        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailModal').classList.add('active');
    } catch (e) {alert('è·å–è¯¦æƒ…å¤±è´¥: ' + e.message);}
}

function reSubmit(id, title, answer) {
    showSubmitModal(id, title);
}

async function deleteMySubmission(id) {
    try {
        var res = await fetch(API_URL + '/api/submissions/' + id);
        var data = await res.json();
        if (data.submission && ((data.submission.score !== undefined && data.submission.score > 0) || data.submission.feedback)) {
            alert('å·²æ‰¹æ”¹çš„ä½œç­”ä¸å¯åˆ é™¤');
            return;
        }
    } catch (e) {}
    if (!confirm('ç¡®å®šåˆ é™¤è¿™ä»½ä½œç­”ï¼Ÿ')) return;
    try {
        var res = await fetch(API_URL + '/api/submissions/' + id, {method: 'DELETE'});
        var data = await res.json();
        if (data.success) {loadMySubmissions();} else {alert(data.error || 'åˆ é™¤å¤±è´¥');}
    } catch (e) {alert('åˆ é™¤å¤±è´¥: ' + e.message);}
}

async function loadOnlineUsers() {
    try {
        var res = await fetch(API_URL + '/api/attendance/online');
        var data = await res.json();
        document.getElementById('onlineCount').textContent = (data.online || []).length;
        var tbody = document.querySelector('#attendanceTable tbody');
        var html = '';
        if (data.online && data.online.length > 0) {
            for (var u of data.online) {
                var lastActive = new Date(u.last_active).toLocaleString();
                html += '<tr><td>' + (u.full_name || u.username) + '</td><td><span class="role-badge role-' + u.role + '">' + getRoleName(u.role) + '</span></td><td>-</td><td>' + lastActive + '</td><td>-</td><td><span class="online-badge">åœ¨çº¿</span></td></tr>';
            }
        }
        tbody.innerHTML = html || '<tr><td colspan="6" class="empty-message">æš‚æ— åœ¨çº¿ç”¨æˆ·</td></tr>';
    } catch (e) {console.error(e);}
}

async function loadAttendanceRecords() {
    try {
        var res = await fetch(API_URL + '/api/attendance/records');
        var data = await res.json();
        var tbody = document.querySelector('#attendanceTable tbody');
        var html = '';
        if (data.records && data.records.length > 0) {
            for (var r of data.records) {
                var duration = r.session_duration ? Math.round(r.session_duration / 60) + 'åˆ†é’Ÿ' : '-';
                var lastActive = r.last_active ? new Date(r.last_active).toLocaleString() : '-';
                var status = r.last_active && new Date(r.last_active) > new Date(Date.now() - 5*60*1000) ? '<span class="online-badge">åœ¨çº¿</span>' : '<span class="offline-badge">ç¦»çº¿</span>';
                html += '<tr><td>' + (r.full_name || r.username) + '</td><td><span class="role-badge role-' + r.role + '">' + getRoleName(r.role) + '</span></td><td>' + new Date(r.login_time).toLocaleString() + '</td><td>' + lastActive + '</td><td>' + duration + '</td><td>' + status + '</td></tr>';
            }
        } else {
            html = '<tr><td colspan="6" class="empty-message">æš‚æ— è€ƒå‹¤è®°å½•</td></tr>';
        }
        tbody.innerHTML = html;
    } catch (e) {console.error(e);}
}

async function loadClassStats() {
    try {
        var res = await fetch(API_URL + '/api/stats/class');
        var data = await res.json();
        document.getElementById('statStudents').textContent = data.total_students || 0;
        document.getElementById('statOnline').textContent = '-';
        document.getElementById('statSessions').textContent = data.today_sessions || 0;
    } catch (e) {console.error(e);}
}

async function loadLogs() {
    try {
        var res = await fetch(API_URL + '/api/logs');
        var data = await res.json();
        var html = '';
        for (var l of (data.logs || [])) {
            html += '<div class="log-entry"><span class="time">' + new Date(l.created_at).toLocaleString() + '</span> <span class="action">' + l.username + '</span> ' + l.action + ' ' + l.target + ': ' + l.details + '</div>';
        }
        document.getElementById('logsList').innerHTML = html || '<p class="empty-message">æš‚æ— æ—¥å¿—</p>';
    } catch (e) {document.getElementById('logsList').innerHTML = '<p class="empty-message">åŠ è½½å¤±è´¥</p>';}
}

function autoSignin() {
    if (currentUser && currentUser.role === 'student') {
        fetch(API_URL + '/api/attendance/auto', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: currentUser.id})
        }).catch(function(e) {console.log('è‡ªåŠ¨ç­¾åˆ°å¤±è´¥:', e);});
    }
}

var whiteboardCanvas, whiteboardCtx, isDrawing = false, isPanning = false;
var lastX = 0, lastY = 0, startX = 0, startY = 0;
var currentTool = 'pen', whiteboardColor = '#000000', lineWidth = 2, drawAllowed = true;
var whiteboardImage = null;
var pendingDrawings = [];
var syncTimer = null;
var lastSyncTime = 0;

function initWhiteboard() {
    whiteboardCanvas = document.getElementById('whiteboardCanvas');
    var container = whiteboardCanvas.parentElement;
    whiteboardCanvas.width = container.offsetWidth;
    whiteboardCanvas.height = 500;
    whiteboardCtx = whiteboardCanvas.getContext('2d');
    
    whiteboardCtx.strokeStyle = whiteboardColor;
    whiteboardCtx.lineWidth = lineWidth;
    whiteboardCtx.lineCap = 'round';
    whiteboardCtx.lineJoin = 'round';
    
    whiteboardCanvas.addEventListener('mousedown', handleMouseDown);
    whiteboardCanvas.addEventListener('mousemove', handleMouseMove);
    whiteboardCanvas.addEventListener('mouseup', handleMouseUp);
    whiteboardCanvas.addEventListener('mouseleave', handleMouseUp);
    whiteboardCanvas.addEventListener('contextmenu', function(e) { e.preventDefault(); });
    
    whiteboardCanvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        var touch = e.touches[0];
        var rect = whiteboardCanvas.getBoundingClientRect();
        handleMouseDown({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top, button: e.button });
    }, { passive: false });
    
    whiteboardCanvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        var touch = e.touches[0];
        var rect = whiteboardCanvas.getBoundingClientRect();
        handleMouseMove({ offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top });
    }, { passive: false });
    
    whiteboardCanvas.addEventListener('touchend', handleMouseUp);
    
    document.getElementById('colorPicker').addEventListener('change', function(e) {
        whiteboardColor = e.target.value;
    });
    
    if (currentUser && currentUser.role === 'teacher') {
        document.getElementById('whiteboardTeacherControls').style.display = 'flex';
    }
    
    loadWhiteboard();
    startSyncLoop();
}

function toggleWhiteboardDraw() {
    var allowed = document.getElementById('whiteboardAllowDraw').checked;
    fetch(API_URL + '/api/whiteboard/settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({allowed: allowed})
    }).then(function(res){return res.json();}).then(function(data){
        if (!data.success) {
            alert('è®¾ç½®å¤±è´¥');
            document.getElementById('whiteboardAllowDraw').checked = !allowed;
        } else {
            updateDrawStatus();
        }
    });
}

function setTool(tool) {
    currentTool = tool;
    document.querySelectorAll('.whiteboard-toolbar button').forEach(function(btn) {
        btn.classList.remove('active');
    });
    var btnId = 'btn' + tool.charAt(0).toUpperCase() + tool.slice(1);
    var btn = document.getElementById(btnId);
    if (btn) btn.classList.add('active');
    if (event && event.target) event.target.classList.add('active');
}

function setLineWidth(width) {
    lineWidth = width;
}

function handleMouseDown(e) {
    if (!drawAllowed && currentUser.role !== 'teacher') {
        showStatus('è€å¸ˆæ²¡æœ‰å…è®¸ä½¿ç”¨');
        return;
    }
    
    isDrawing = true;
    isPanning = e.button === 2;
    lastX = e.offsetX;
    lastY = e.offsetY;
    startX = e.offsetX;
    startY = e.offsetY;
    
    if (currentTool === 'text') {
        var text = prompt('è¾“å…¥æ–‡å­—ï¼š');
        if (text) {
            whiteboardCtx.font = lineWidth * 8 + 'px Arial';
            whiteboardCtx.fillStyle = whiteboardColor;
            whiteboardCtx.fillText(text, lastX, lastY);
            saveDrawing({type: 'text', x: lastX, y: lastY, text: text, color: whiteboardColor, size: lineWidth * 8});
        }
        isDrawing = false;
    }
}

function handleMouseMove(e) {
    if (!isDrawing) return;
    
    whiteboardCtx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : whiteboardColor;
    whiteboardCtx.lineWidth = currentTool === 'eraser' ? lineWidth * 5 : lineWidth;
    
    whiteboardCtx.beginPath();
    whiteboardCtx.moveTo(lastX, lastY);
    whiteboardCtx.lineTo(e.offsetX, e.offsetY);
    whiteboardCtx.stroke();
    
    var drawing = {
        type: currentTool,
        x1: lastX,
        y1: lastY,
        x2: e.offsetX,
        y2: e.offsetY,
        color: whiteboardCtx.strokeStyle,
        width: whiteboardCtx.lineWidth
    };
    
    pendingDrawings.push(drawing);
    scheduleSync();
    
    lastX = e.offsetX;
    lastY = e.offsetY;
}

function handleMouseUp(e) {
    if (!isDrawing) return;
    isDrawing = false;
    isPanning = false;
    syncNow();
}

function scheduleSync() {
    if (syncTimer) clearTimeout(syncTimer);
    syncTimer = setTimeout(syncNow, 100);
}

function syncNow() {
    var now = Date.now();
    if (now - lastSyncTime < 500 && pendingDrawings.length < 10) return;
    if (pendingDrawings.length === 0) return;
    
    lastSyncTime = now;
    var drawings = pendingDrawings.slice();
    pendingDrawings = [];
    
    var dataUrl = whiteboardCanvas.toDataURL();
    fetch(API_URL + '/api/whiteboard', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: currentUser.id,
            content: dataUrl,
            drawings: drawings
        })
    }).then(function() {
        showStatus('å·²åŒæ­¥ - ' + new Date().toLocaleTimeString());
    }).catch(function() {
        pendingDrawings = drawings.concat(pendingDrawings);
    });
}

function startSyncLoop() {
    setInterval(function() {
        if (pendingDrawings.length > 0) {
            syncNow();
        }
        loadWhiteboard();
    }, 2000);
}

function showStatus(msg) {
    document.getElementById('syncStatus').textContent = msg;
}

function clearWhiteboard() {
    if (!drawAllowed && currentUser.role !== 'teacher') {
        showStatus('è€å¸ˆæ²¡æœ‰å…è®¸ä½¿ç”¨');
        return;
    }
    whiteboardCtx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
    whiteboardImage = null;
    syncNow();
}

async function loadWhiteboard() {
    if (!currentUser) return;
    try {
        var res = await fetch(API_URL + '/api/whiteboard');
        var data = await res.json();
        
        drawAllowed = currentUser.role === 'teacher' || data.allowed === true;
        updateDrawStatus();
        
        if (currentUser.role === 'teacher' && data.allowed === undefined) {
            drawAllowed = true;
        }
        
        if (data.drawings && data.drawings.length > 0) {
            loadRemoteDrawings(data.drawings);
        }
        
        if (data.content && data.content !== (whiteboardImage || '')) {
            whiteboardImage = data.content;
            var img = new Image();
            img.onload = function() {
                whiteboardCtx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
                whiteboardCtx.drawImage(img, 0, 0);
            };
            img.src = data.content;
        }
        
        var onlineCount = data.online_count || 0;
        document.getElementById('whiteboardOnline').textContent = 'ğŸ‘¥ ' + onlineCount + ' äººåœ¨çº¿';
    } catch (e) { console.error('åŠ è½½ç™½æ¿å¤±è´¥:', e); }
}

function loadRemoteDrawings(drawings) {
    for (var i = 0; i < drawings.length; i++) {
        var d = drawings[i];
        whiteboardCtx.strokeStyle = d.color || '#000000';
        whiteboardCtx.lineWidth = d.width || 2;
        whiteboardCtx.beginPath();
        whiteboardCtx.moveTo(d.x1, d.y1);
        whiteboardCtx.lineTo(d.x2, d.y2);
        whiteboardCtx.stroke();
    }
}

function updateDrawStatus() {
    var overlay = document.getElementById('whiteboardOverlay');
    var toolbarBtns = document.querySelectorAll('.whiteboard-toolbar button:not(:last-child)');
    
    if (drawAllowed) {
        overlay.style.display = 'none';
        toolbarBtns.forEach(function(btn) {
            btn.disabled = false;
            btn.style.opacity = '1';
        });
    } else {
        overlay.style.display = 'flex';
        toolbarBtns.forEach(function(btn) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        });
    }
}
    
function changePassword() {
    var oldPwd = document.getElementById('oldPassword').value;
    var newPwd = document.getElementById('newPassword').value;
    var confirmPwd = document.getElementById('confirmPassword').value;
    if (!oldPwd || !newPwd) {alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');return;}
    if (newPwd !== confirmPwd) {alert('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´');return;}
    if (newPwd.length < 6) {alert('å¯†ç é•¿åº¦è‡³å°‘6ä½');return;}
    fetch(API_URL + '/api/users/password', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: currentUser.id, old_password: oldPwd, new_password: newPwd})
    }).then(res => res.json()).then(data => {
        if (data.success) {alert('å¯†ç ä¿®æ”¹æˆåŠŸ');closeModal('passwordModal');} else {alert(data.error || 'ä¿®æ”¹å¤±è´¥');}
    }).catch(e => alert('ä¿®æ”¹å¤±è´¥: ' + e.message));
}

function closeModal(id) {
    var modal = document.getElementById(id);
    if (modal) modal.classList.remove('active');
}

document.getElementById('passwordModal') && document.getElementById('passwordModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('passwordModal');
});
document.getElementById('userModal') && document.getElementById('userModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('userModal');
});
document.getElementById('assignmentModal') && document.getElementById('assignmentModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('assignmentModal');
});
document.getElementById('detailModal') && document.getElementById('detailModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('detailModal');
});
document.getElementById('submitModal') && document.getElementById('submitModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('submitModal');
});

var gameState = {matchId:null, opponent:null, questions:[], currentQ:null, currentQIdx:0, selected:[], canAnswer:false,
                 hp:100, maxHp:100, opponentHp:100, opponentMaxHp:100, buffs:{dmg:0, shield:false},
                 inventory:[], playerData:null, isMyTurn:true, waitingAnswer:false, waitingResult:false, isTeacher:false,
                 lastActive:null, inGame:false, inMatching:false, isPlayer1:false};
var gamePollTimer = null;
var gameHeartbeatTimer = null;
var GAME_ITEMS = {heal:{e:'ğŸ',t:'heal'},shield:{e:'ğŸ›¡ï¸',t:'shield'},dmg:{e:'âš¡',t:'dmg'}};

async function initGame() {
    loadPlayerGameData();
    loadGameLeaderboard();
    
    if (currentUser.role === 'teacher' || currentUser.role === 'admin') {
        gameState.isTeacher = true;
        document.getElementById('teacherGameArea').style.display = 'block';
        document.getElementById('studentGameArea').style.display = 'none';
        loadStudentGameStatus();
        setInterval(loadStudentGameStatus, 3000);
    } else {
        document.getElementById('teacherGameArea').style.display = 'none';
        document.getElementById('studentGameArea').style.display = 'block';
        checkMyGameMatch();
    }
}

async function loadStudentGameStatus() {
    try {
        var res = await fetch(API_URL + '/api/game/students');
        var data = await res.json();
        var html = '';
        if (data.students && data.students.length > 0) {
            html = '<table style="width:100%;font-size:13px"><thead><tr><th>å­¦ç”Ÿ</th><th>çŠ¶æ€</th><th>å‹‹ç« </th></tr></thead><tbody>';
            data.students.forEach(function(s) {
                var statusClass = s.status === 'matching' ? 'color:#f39c12' : (s.status === 'playing' ? 'color:#27ae60' : 'color:#999');
                var statusText = s.status === 'matching' ? 'ğŸ” åŒ¹é…ä¸­' : (s.status === 'playing' ? 'âš”ï¸ å¯¹æˆ˜ä¸­' : 'ğŸ›‘ ç¦»çº¿');
                html += '<tr><td>' + s.full_name + '</td><td style="' + statusClass + '">' + statusText + '</td><td>' + s.medals + '</td></tr>';
            });
            html += '</tbody></table>';
        } else {
            html = '<p style="color:#999;text-align:center">æš‚æ— å­¦ç”Ÿåœ¨çº¿</p>';
        }
        document.getElementById('studentGameStatus').innerHTML = html;
    } catch(e) {
        document.getElementById('studentGameStatus').innerHTML = '<p style="color:#999;text-align:center">åŠ è½½å¤±è´¥</p>';
    }
}

async function checkMyGameMatch() {
    try {
        var url = API_URL + '/api/game/check?user_id=' + currentUser.id;
        var res = await fetch(url);
        var data = await res.json();
        console.log('checkMyGameMatch:', data);
        if (data.in_match && data.match) {
            console.log('Found match:', data.match);
            var match = data.match;
            gameState.inMatching = false;
            gameState.inGame = true;
            gameState.matchId = match.match_id;
            gameState.currentQIdx = match.current_question_idx;
            gameState.waitingResult = false;
            var isP1 = match.player1 === currentUser.id;
            gameState.isPlayer1 = isP1;
            gameState.opponent = isP1 ? match.player2_data : match.player1_data;
            gameState.hp = isP1 ? match.player1_hp : match.player2_hp;
            gameState.opponentHp = isP1 ? match.player2_hp : match.player1_hp;
            gameState.maxHp = 100;
            gameState.opponentMaxHp = 100;
            gameState.buffs = {dmg:0, shield:false};
            
            document.getElementById('gameMatchArea').style.display = 'none';
            document.getElementById('gamePlayArea').style.display = 'block';
            document.getElementById('enemyGameName').textContent = gameState.opponent.full_name || gameState.opponent.username;
            document.getElementById('heroGameHp').style.width = '100%';
            document.getElementById('enemyGameHp').style.width = '100%';
            
            if (gameHeartbeatTimer) clearInterval(gameHeartbeatTimer);
            gameHeartbeatTimer = setInterval(sendGameHeartbeat, 30000);
            pollGameState();
        } else if (data.matching) {
            gameState.inGame = false;
            gameState.inMatching = true;
            document.getElementById('matchStatus').textContent = 'ç­‰å¾…åŒ¹é…ä¸­...';
            document.getElementById('matchBtn').disabled = true;
            document.getElementById('matchBtn').textContent = 'åŒ¹é…ä¸­...';
            checkMyGameMatchAfterStart();
        } else {
            gameState.inGame = false;
            gameState.inMatching = false;
            gameState.matchId = null;
            document.getElementById('matchStatus').textContent = 'ç‚¹å‡»å¼€å§‹åŒ¹é…';
            document.getElementById('matchBtn').disabled = false;
            document.getElementById('matchBtn').textContent = 'ğŸ® å¼€å§‹åŒ¹é…';
        }
    } catch(e) { 
        console.error('checkMyGameMatch error:', e);
        gameState.inMatching = false;
        setTimeout(checkMyGameMatch, 3000);
    }
}

async function loadPlayerGameData() {
    try {
        var res = await fetch(API_URL + '/api/game/player?user_id=' + currentUser.id);
        var data = await res.json();
        gameState.playerData = data.player;
        document.getElementById('playerGold').textContent = data.player.gold || 0;
        document.getElementById('playerMedals').textContent = data.player.medals || 0;
        document.getElementById('playerWins').textContent = data.player.wins || 0;
        gameState.inventory = data.player.inventory || [];
        renderGameInventory();
    } catch(e) {console.error(e);}
}

function renderGameInventory() {
    var html = '';
    gameState.inventory.forEach(function(item, i) {
        html += '<div class="game-item-slot" onclick="useGameItem(' + i + ')" title="' + (item.name || '') + '">' + item.e + '</div>';
    });
    document.getElementById('gameInventory').innerHTML = html || '<span style="color:#999;font-size:13px">èƒŒåŒ…ç©ºç©ºçš„~</span>';
}

async function startMatch() {
    var btn = document.getElementById('matchBtn');
    btn.disabled = true;
    btn.textContent = 'åŒ¹é…ä¸­...';
    document.getElementById('matchStatus').textContent = 'æ­£åœ¨å¯»æ‰¾å¯¹æ‰‹...';
    gameState.inMatching = true;
    gameState.matchId = null;
    gameState.inGame = false;
    
    try {
        var res = await fetch(API_URL + '/api/game/match', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user_id: currentUser.id})
        });
        var data = await res.json();
        console.log('startMatch response:', data);
        if (data.success) {
            gameState.inMatching = false;
            gameState.inGame = true;
            gameState.matchId = data.match_id;
            gameState.isPlayer1 = data.is_player1 === true;
            gameState.player1Id = data.player1_id;
            gameState.opponent = data.opponent;
            gameState.hp = 100;
            gameState.opponentHp = 100;
            gameState.maxHp = 100;
            gameState.opponentMaxHp = 100;
            gameState.buffs = {dmg:0, shield:false};
            gameState.waitingResult = false;
            
            document.getElementById('gameMatchArea').style.display = 'none';
            document.getElementById('gamePlayArea').style.display = 'block';
            document.getElementById('enemyGameName').textContent = gameState.opponent.full_name || gameState.opponent.username;
            document.getElementById('heroGameHp').style.width = '100%';
            document.getElementById('enemyGameHp').style.width = '100%';
            
            if (gameHeartbeatTimer) clearInterval(gameHeartbeatTimer);
            gameHeartbeatTimer = setInterval(sendGameHeartbeat, 30000);
            pollGameState();
        } else {
            document.getElementById('matchStatus').textContent = data.message || 'ç­‰å¾…åŒ¹é…ä¸­...';
            checkMyGameMatchAfterStart();
        }
    } catch(e) {
        console.error('startMatch error:', e);
        document.getElementById('matchStatus').textContent = 'åŒ¹é…å¤±è´¥: ' + e.message;
        btn.disabled = false;
        btn.textContent = 'ğŸ® å¼€å§‹åŒ¹é…';
        gameState.inMatching = false;
    }
}

function checkMyGameMatchAfterStart() {
    if (gameState.inMatching) {
        fetch(API_URL + '/api/game/check?user_id=' + currentUser.id)
            .then(function(res){return res.json();})
            .then(function(data){
                console.log('checkMyGameMatchAfterStart:', data);
                if (data.in_match && data.match) {
                    var match = data.match;
                    gameState.inMatching = false;
                    gameState.inGame = true;
                    gameState.matchId = match.match_id;
                    var isP1 = match.player1 === currentUser.id;
                    gameState.isPlayer1 = isP1;
                    gameState.opponent = isP1 ? match.player2_data : match.player1_data;
                    gameState.hp = 100;
                    gameState.opponentHp = 100;
                    gameState.maxHp = 100;
                    gameState.opponentMaxHp = 100;
                    gameState.buffs = {dmg:0, shield:false};
                    
                    document.getElementById('gameMatchArea').style.display = 'none';
                    document.getElementById('gamePlayArea').style.display = 'block';
                    document.getElementById('enemyGameName').textContent = gameState.opponent.full_name || gameState.opponent.username;
                    document.getElementById('heroGameHp').style.width = '100%';
                    document.getElementById('enemyGameHp').style.width = '100%';
                    updateGameUI();
                    
                    if (gameHeartbeatTimer) clearInterval(gameHeartbeatTimer);
                    gameHeartbeatTimer = setInterval(sendGameHeartbeat, 30000);
                    pollGameState();
                } else if (data.matching) {
                    setTimeout(checkMyGameMatchAfterStart, 1000);
                } else {
                    gameState.inMatching = false;
                    document.getElementById('matchStatus').textContent = 'ç‚¹å‡»å¼€å§‹åŒ¹é…';
                    document.getElementById('matchBtn').disabled = false;
                    document.getElementById('matchBtn').textContent = 'ğŸ® å¼€å§‹åŒ¹é…';
                }
            })
            .catch(function(){
                setTimeout(checkMyGameMatchAfterStart, 2000);
            });
    }
}

function pollGameState() {
    if (!gameState.inGame) {
        console.log('pollGameState skipped: inGame=', gameState.inGame);
        return;
    }

    var url = API_URL + '/api/game/state?match_id=' + gameState.matchId + '&user_id=' + currentUser.id;
    fetch(url)
        .then(function(res){return res.json();})
        .then(function(data){
            console.log('pollGameState:', data);

            if (!data.success) {
                console.log('pollGameState failed:', data.message);
                if (data.timeout) {
                    showGameResult(true, 'å¯¹æ‰‹è¶…æ—¶ï¼Œèƒœåˆ©ï¼', 0);
                } else if (data.game_over) {
                    handleGameOver({winner: data.winner});
                } else if (data.opponent_left) {
                    showGameResult(true, 'å¯¹æ‰‹å·²ç¦»å¼€ï¼Œèƒœåˆ©ï¼', 0);
                } else {
                    // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨åŒ¹é…ä¸­
                    checkMyGameMatch();
                }
                return;
            }

            // æ£€æŸ¥å¯¹æ‰‹æ˜¯å¦ç¦»å¼€
            if (data.opponent_left) {
                showGameResult(true, 'å¯¹æ‰‹å·²ç¦»å¼€ï¼Œèƒœåˆ©ï¼', 0);
                return;
            }

            // æ›´æ–°è¡€é‡
            gameState.hp = data.hp;
            gameState.opponentHp = data.opponent_hp;
            
            // æ›´æ–°UI
            document.getElementById('heroGameHp').style.width = (gameState.hp / gameState.maxHp * 100) + '%';
            document.getElementById('enemyGameHp').style.width = (gameState.opponentHp / gameState.opponentMaxHp * 100) + '%';
            
            // æ¸¸æˆç»“æŸ
            if (data.game_over) {
                handleGameOver({winner: data.winner});
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦è¿›å…¥ä¸‹ä¸€é¢˜
            if (data.current_question && !gameState.currentQ) {
                // ç¬¬ä¸€æ¬¡åŠ è½½é¢˜ç›®æˆ–é¢˜ç›®æœªæ˜¾ç¤º
                console.log('Loading question:', data.current_question);
                gameState.currentQIdx = data.current_question_idx;
                gameState.waitingAnswer = false;
                showGameQuestion(data.current_question);
            } else if (data.current_question && data.current_question_idx !== gameState.currentQIdx) {
                // è¿›å…¥æ–°çš„ä¸€é¢˜
                console.log('New question:', data.current_question);
                gameState.currentQIdx = data.current_question_idx;
                gameState.waitingAnswer = false;
                showGameQuestion(data.current_question);
            } else if (data.current_question) {
                // åŒä¸€é¢˜ï¼Œæ£€æŸ¥çŠ¶æ€
                if (data.both_answered) {
                    // åŒæ–¹éƒ½ç­”å®Œäº†ï¼Œç­‰å¾…æ˜¾ç¤ºç»“æœ
                    if (!gameState.waitingResult) {
                        gameState.waitingResult = true;
                        document.getElementById('gameMessage').textContent = 'åŒæ–¹éƒ½ç­”å®Œäº†ï¼Œåˆ¤å®šä¸­...';
                        document.getElementById('gameOptions').innerHTML = '<div style="text-align:center;color:#999;padding:20px">ç­‰å¾…åˆ¤å®šç»“æœ...</div>';
                        // 2ç§’ååˆ·æ–°çŠ¶æ€
                        setTimeout(function(){
                            gameState.waitingResult = false;
                            pollGameState();
                        }, 2000);
                    }
                } else if (data.player_answered) {
                    // å½“å‰ç©å®¶å·²ç­”ï¼Œç­‰å¾…å¯¹æ‰‹
                    gameState.waitingAnswer = true;
                    document.getElementById('gameMessage').textContent = 'â³ å·²ç­”é¢˜ï¼Œç­‰å¾…å¯¹æ‰‹...';
                    document.getElementById('gameOptions').innerHTML = '<div style="text-align:center;color:#999;padding:20px">ç­‰å¾…å¯¹æ‰‹ç­”é¢˜...</div>';
                }
            } else if (!data.current_question && data.current_question_idx >= data.total_questions) {
                // æ‰€æœ‰é¢˜ç›®ç­”å®Œäº†
                handleGameOver({winner: data.hp > data.opponent_hp ? currentUser.id : (data.hp < data.opponent_hp ? 'opponent' : 'draw')});
            }
            
            sendGameHeartbeat();
            gamePollTimer = setTimeout(pollGameState, 1000);
        })
        .catch(function(e){ 
            console.error('pollGameState error:', e);
            gamePollTimer = setTimeout(pollGameState, 2000); 
        });
}

function updateGameUI() {
    document.getElementById('heroGameHp').style.width = (gameState.hp / gameState.maxHp * 100) + '%';
    document.getElementById('enemyGameHp').style.width = (gameState.opponentHp / gameState.opponentMaxHp * 100) + '%';
    var buffs = '';
    if (gameState.buffs.shield) buffs += 'ğŸ›¡ï¸';
    if (gameState.buffs.dmg > 0) buffs += 'âš¡x' + gameState.buffs.dmg;
    document.getElementById('heroGameBuffs').textContent = buffs;
    var msgs = [];
    if (gameState.isMyTurn) msgs.push('ğŸ¯ è½®åˆ°ä½ äº†');
    else msgs.push('â³ å¯¹æ‰‹æ­£åœ¨ç­”é¢˜...');
    document.getElementById('gameMessage').textContent = msgs.join(' | ');
}

function showGameQuestion(q) {
    gameState.currentQ = q;
    gameState.selected = [];
    gameState.waitingAnswer = true;
    gameState.canAnswer = true;
    document.getElementById('gameQType').textContent = q.is_multi ? 'å¤šé€‰é¢˜' : 'å•é€‰é¢˜';
    document.getElementById('gameQText').textContent = q.question;
    var opts = document.getElementById('gameOptions');
    opts.innerHTML = '';
    var letters = ['A','B','C','D'];
    q.options.forEach(function(opt, i) {
        var btn = document.createElement('div');
        btn.className = 'game-option-btn';
        btn.innerHTML = '<span style="font-weight:bold;color:#a29bfe;margin-right:8px">' + letters[i] + '</span>' + opt;
        btn.onclick = function() { selectGameOption(i, btn, letters[i], q.is_multi); };
        opts.appendChild(btn);
    });
    document.getElementById('gameActionBtns').style.display = q.is_multi ? 'block' : 'none';
    document.getElementById('gameSubmitBtn').style.display = 'none';
    document.getElementById('gameContinueBtn').style.display = 'none';
}

function selectGameOption(idx, btn, letter, isMulti) {
    if (!gameState.canAnswer) return;
    if (isMulti) {
        if (gameState.selected.includes(letter)) {
            gameState.selected = gameState.selected.filter(function(t){return t !== letter;});
            btn.classList.remove('selected');
        } else {
            gameState.selected.push(letter);
            btn.classList.add('selected');
        }
        document.getElementById('gameSubmitBtn').style.display = gameState.selected.length > 0 ? 'block' : 'none';
    } else {
        gameState.canAnswer = false;
        gameState.selected = [letter];
        document.querySelectorAll('.game-option-btn').forEach(function(b){b.classList.remove('selected');});
        btn.classList.add('selected');
        submitGameAnswer();
    }
}

function submitGameAnswer() {
    if (!gameState.canAnswer || gameState.selected.length === 0) return;
    gameState.canAnswer = false;
    var answer = gameState.selected.join('');
    var isCorrect = checkGameAnswer(answer);
    submitGameResult(answer, isCorrect);
}

function checkGameAnswer(answer) {
    var correct = gameState.currentQ.answer.split(',').sort().join('');
    return answer.split(',').sort().join('') === correct;
}

function submitGameResult(answer, isCorrect) {
    fetch(API_URL + '/api/game/answer', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({match_id: gameState.matchId, user_id: currentUser.id, answer: answer, is_correct: isCorrect})
    }).then(function(res){return res.json();}).then(function(data){
        if (data.success) {
            document.getElementById('gameSubmitBtn').style.display = 'none';
            gameState.waitingAnswer = true;
            
            if (data.round_result) {
                var r = data.round_result;
                var isP1 = gameState.isPlayer1;
                var myDmg = isP1 ? r.p1_dmg : r.p2_dmg;
                var myHp = isP1 ? r.p1_hp : r.p2_hp;
                var oppHp = isP1 ? r.p2_hp : r.p1_hp;
                
                var emoji = '';
                var msg = '';
                if (myDmg === 0) {
                    emoji = 'âœ…';
                    msg = 'ä½ ç­”å¯¹äº†ï¼';
                    if (isP1 ? !r.p2_correct : !r.p1_correct) {
                        msg += 'å¯¹æ–¹ç­”é”™ï¼Œæ‰£é™¤20è¡€';
                    } else {
                        msg += 'å¯¹æ–¹ä¹Ÿç­”å¯¹';
                    }
                } else {
                    emoji = 'âŒ';
                    msg = 'ä½ ç­”é”™äº†ï¼æ‰£é™¤' + myDmg + 'è¡€';
                }
                
                document.getElementById('gameMessage').innerHTML = '<span style="font-size:20px">' + emoji + '</span><br>' + msg + '<br><span style="color:#999">æˆ‘:' + myHp + ' å¯¹æ‰‹:' + oppHp + '</span>';
                
                gameState.hp = myHp;
                gameState.opponentHp = oppHp;
                document.getElementById('heroGameHp').style.width = (myHp / 100 * 100) + '%';
                document.getElementById('enemyGameHp').style.width = (oppHp / 100 * 100) + '%';
            } else {
                document.getElementById('gameMessage').textContent = 'â³ å·²ç­”é¢˜ï¼Œç­‰å¾…å¯¹æ‰‹...';
                document.getElementById('gameOptions').innerHTML = '<div style="text-align:center;color:#999;padding:20px">ç­‰å¾…å¯¹æ‰‹ç­”é¢˜...</div>';
            }
        }
    });
}
                }
                var myCorrect = isP1 ? r.p1_correct : r.p2_correct;
                var myDmg = isP1 ? r.p2_dmg : r.p1_dmg;
                var myHp = isP1 ? r.p1_hp : r.p2_hp;
                var oppHp = isP1 ? r.p2_hp : r.p1_hp;
                
                var emoji = '';
                var msg = '';
                if (myCorrect && myDmg === 0) {
                    emoji = 'âœ…';
                    msg = 'ä½ ç­”å¯¹äº†ï¼å¯¹æ–¹ç­”é”™ï¼Œæ‰£é™¤20è¡€';
                } else if (!myCorrect && myDmg > 0) {
                    emoji = 'âŒ';
                    msg = 'ä½ ç­”é”™äº†ï¼æ‰£é™¤' + myDmg + 'è¡€';
                } else if (myCorrect && myDmg > 0) {
                    emoji = 'ğŸ¤';
                    msg = 'åŒæ–¹éƒ½ç­”å¯¹ï¼';
                } else {
                    emoji = 'ğŸ˜”';
                    msg = 'åŒæ–¹éƒ½ç­”é”™ï¼å„æ‰£10è¡€';
                }
                
                document.getElementById('gameMessage').innerHTML = '<span style="font-size:20px">' + emoji + '</span><br>' + msg + '<br><span style="color:#999">æˆ‘:' + myHp + ' å¯¹æ‰‹:' + oppHp + '</span>';
                
                gameState.hp = myHp;
                gameState.opponentHp = oppHp;
                document.getElementById('heroGameHp').style.width = (myHp / 100 * 100) + '%';
                document.getElementById('enemyGameHp').style.width = (oppHp / 100 * 100) + '%';
            } else {
                document.getElementById('gameMessage').textContent = 'â³ å·²ç­”é¢˜ï¼Œç­‰å¾…å¯¹æ‰‹...';
                document.getElementById('gameOptions').innerHTML = '<div style="text-align:center;color:#999;padding:20px">ç­‰å¾…å¯¹æ‰‹ç­”é¢˜...</div>';
            }
        }
    });
}

function sendGameHeartbeat() {
    if (!gameState.matchId) return;
    fetch(API_URL + '/api/game/heartbeat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({match_id: gameState.matchId, user_id: currentUser.id})
    }).catch(function(){});
}

function nextGameQuestion() {
    gameState.waitingAnswer = false;
    var opts = document.getElementById('gameOptions');
    opts.innerHTML = '<div style="text-align:center;color:#999;padding:20px">ç­‰å¾…å¯¹æ‰‹ç­”é¢˜...</div>';
    document.getElementById('gameQText').textContent = '...';
    document.getElementById('gameQType').textContent = 'ç­‰å¾…';
    document.getElementById('gameActionBtns').style.display = 'none';
    gameState.currentQ = null;
    if (gameState.inGame && gameState.matchId) {
        pollGameState();
    }
}

function useGameItem(idx) {
    var item = gameState.inventory[idx];
    if (!item) return;
    if (item.t === 'heal') {
        gameState.hp = Math.min(gameState.maxHp, gameState.hp + 40);
        showGameMessage('ä½¿ç”¨äº†è‹¹æœï¼Œæ¢å¤40è¡€é‡');
    } else if (item.t === 'shield') {
        gameState.buffs.shield = true;
        showGameMessage('ä½¿ç”¨æŠ¤ç›¾ï¼Œä¸‹æ¬¡ä¼¤å®³æ— æ•ˆ');
    } else if (item.t === 'dmg') {
        gameState.buffs.dmg = 2;
        showGameMessage('ä½¿ç”¨ç‹‚æš´ï¼Œä¸‹æ¬¡ä¼¤å®³ç¿»å€');
    }
    gameState.inventory.splice(idx, 1);
    renderGameInventory();
    updateGameUI();
    saveGameInventory();
}

function showGameMessage(msg) {
    document.getElementById('gameMessage').textContent = msg;
}

async function saveGameInventory() {
    try {
        await fetch(API_URL + '/api/game/inventory', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user_id: currentUser.id, inventory: gameState.inventory})
        });
    } catch(e) {console.error(e);}
}

function quitGame(forced) {
    if (!forced && !confirm('ç¡®å®šè¦è®¤è¾“é€€å‡ºå—ï¼Ÿ')) return;
    if (gamePollTimer) clearTimeout(gamePollTimer);
    if (gameHeartbeatTimer) clearInterval(gameHeartbeatTimer);
    gameState.inGame = false;
    gameState.inMatching = false;
    gameState.matchId = null;
    fetch(API_URL + '/api/game/quit', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({match_id: gameState.matchId, user_id: currentUser.id})
    }).then(function(res){return res.json();}).then(function(){
        showGameResult(false, 'ä½ è®¤è¾“äº†', 0);
    });
}

function handleGameOver(data) {
    if (gamePollTimer) clearTimeout(gamePollTimer);
    if (gameHeartbeatTimer) clearInterval(gameHeartbeatTimer);
    gameState.inGame = false;
    gameState.inMatching = false;
    gameState.matchId = null;
    
    var isWin = data.winner === currentUser.id || data.winner == currentUser.id;
    var isDraw = data.winner === 'draw' || data.winner === 'draw';
    
    if (isWin) {
        var gold = Math.floor(Math.random() * 11) + 10;
        showGameResult(true, 'èƒœåˆ©ï¼', gold);
    } else if (isDraw) {
        showGameResult('draw', 'å¹³å±€ï¼', 0);
    } else {
        showGameResult(false, 'å¤±è´¥äº†', 0);
    }
}

function showGameResult(win, title, gold) {
    gameState.matchId = null;
    gameState.opponent = null;
    document.getElementById('gamePlayArea').style.display = 'none';
    document.getElementById('gameMatchArea').style.display = 'block';
    document.getElementById('matchBtn').disabled = false;
    document.getElementById('matchBtn').textContent = 'ğŸ® å¼€å§‹åŒ¹é…';
    document.getElementById('matchStatus').textContent = 'ç‚¹å‡»å¼€å§‹åŒ¹é…';
    var modal = document.getElementById('gameResultModal');
    modal.style.display = 'flex';
    document.getElementById('resultEmoji').textContent = win === true ? 'ğŸ†' : (win === 'draw' ? 'ğŸ¤' : 'ğŸ’”');
    document.getElementById('resultTitle').textContent = title;
    document.getElementById('resultDesc').textContent = win === true ? 'æ­å–œä½ æˆ˜èƒœäº†å¯¹æ‰‹ï¼' : (win === 'draw' ? 'åŠ¿å‡åŠ›æ•Œï¼' : 'å†æ¥å†å‰ï¼');
    var rewards = '';
    if (win === true) {
        rewards = 'ğŸ–ï¸ +1 å‹‹ç« <br>ğŸ’° +' + gold + ' é‡‘å¸';
        document.getElementById('playerMedals').textContent = parseInt(document.getElementById('playerMedals').textContent) + 1;
        document.getElementById('playerGold').textContent = parseInt(document.getElementById('playerGold').textContent) + gold;
        document.getElementById('playerWins').textContent = parseInt(document.getElementById('playerWins').textContent) + 1;
    }
    document.getElementById('resultRewards').innerHTML = rewards || 'æ²¡æœ‰å¥–åŠ±';
    loadPlayerGameData();
    loadGameLeaderboard();
}

function showRoundResult(isP1, p1Correct, p2Correct, p1Dmg, p2Dmg, p1Hp, p2Hp) {
    var emoji = '';
    var message = '';
    var myCorrect = isP1 ? p1Correct : p2Correct;
    var myDmg = isP1 ? p2Dmg : p1Dmg;
    
    if (myCorrect && !myDmg) {
        emoji = 'âœ…';
        message = 'ä½ ç­”å¯¹äº†ï¼å¯¹æ‰‹ç­”é”™ï¼Œå¯¹æ–¹æ‰£é™¤20è¡€ï¼';
    } else if (!myCorrect && myDmg > 0) {
        emoji = 'âŒ';
        message = 'ä½ ç­”é”™äº†ï¼æ‰£é™¤' + myDmg + 'è¡€é‡';
    } else if (myCorrect && myDmg === 0) {
        emoji = 'ğŸ¤';
        message = 'åŒæ–¹éƒ½ç­”å¯¹ï¼ç»§ç»­åŠ æ²¹';
    } else {
        emoji = 'ğŸ˜”';
        message = 'åŒæ–¹éƒ½ç­”é”™ï¼å„æ‰£é™¤10è¡€é‡';
    }
    
    var hpText = 'æˆ‘æ–¹: ' + (isP1 ? p1Hp : p2Hp) + ' | å¯¹æ‰‹: ' + (isP1 ? p2Hp : p1Hp);
    
    document.getElementById('gameMessage').innerHTML = '<span style="font-size:24px">' + emoji + '</span><br>' + message + '<br><span style="color:#999;font-size:14px">' + hpText + '</span>';
    
    gameState.hp = isP1 ? p1Hp : p2Hp;
    gameState.opponentHp = isP1 ? p2Hp : p1Hp;
    document.getElementById('heroGameHp').style.width = (gameState.hp / gameState.maxHp * 100) + '%';
    document.getElementById('enemyGameHp').style.width = (gameState.opponentHp / gameState.opponentMaxHp * 100) + '%';
}

function closeGameResult() {
    document.getElementById('gameResultModal').style.display = 'none';
}

async function loadGameLeaderboard() {
    try {
        var res = await fetch(API_URL + '/api/game/leaderboard');
        var data = await res.json();
        var tbody = document.getElementById('leaderboardBody');
        var html = '';
        data.leaderboard.forEach(function(p, i) {
            html += '<tr><td>' + (i+1) + '</td><td>' + (p.full_name || p.username) + '</td><td>' + p.medals + '</td><td>' + p.wins + '</td></tr>';
        });
        tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center;color:#999">æš‚æ— æ•°æ®</td></tr>';
    } catch(e) {console.error(e);}
}

initSession();
</script>
</body>
</html>
