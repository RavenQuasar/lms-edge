<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LMS-Edge ç­çº§å±€åŸŸç½‘æ•™å­¦ç®¡ç†ç³»ç»Ÿ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh}
a{color:#667eea;text-decoration:none}
a:hover{text-decoration:underline}
.container{max-width:1400px;margin:0 auto;padding:20px}
.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh}
.login-box{background:white;padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:100%;max-width:450px;text-align:center}
.dashboard-container{display:none}
.header{background:white;padding:15px 20px;border-radius:15px;margin-bottom:20px;box-shadow:0 5px 20px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.header h1{color:#333;font-size:20px}
.header .user-info{color:#666;font-size:14px}
.header .user-info span{margin-left:15px}
.logout-btn{background:#ff6b6b;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px}
.logout-btn:hover{background:#ee5a5a}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}
.stat-card{background:white;padding:20px;border-radius:12px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,0.08)}
.stat-card h3{color:#667eea;font-size:28px;margin-bottom:5px}
.stat-card p{color:#666;font-size:13px}
.nav-tabs{background:white;padding:12px;border-radius:12px;margin-bottom:20px;display:flex;flex-wrap:wrap;gap:5px;box-shadow:0 3px 10px rgba(0,0,0,0.08)}
.nav-tabs button{flex:1;min-width:100px;padding:12px;border:none;background:white;color:#666;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.2s}
.nav-tabs button:hover{background:#f5f5f5}
.nav-tabs button.active{background:#667eea;color:white}
.content-section{display:none;background:white;padding:20px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.08)}
.content-section.active{display:block}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.2s}
.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
.btn-primary:hover{opacity:0.9}
.btn-success{background:#6bcb77;color:white}
.btn-danger{background:#ff6b6b;color:white}
.btn-warning{background:#ffd93d;color:#333}
.btn-sm{padding:6px 12px;font-size:12px}
.btn:hover{opacity:0.9}
.form-group{margin-bottom:15px;text-align:left}
.form-group label{display:block;margin-bottom:5px;color:#333;font-weight:500;font-size:14px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px}
.form-group textarea{resize:vertical;min-height:80px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px}
th,td{padding:12px;text-align:left;border-bottom:1px solid #eee}
th{background:#f5f5f5;color:#333;font-weight:600}
tr:hover{background:#fafafa}
.role-badge{padding:3px 8px;border-radius:4px;font-size:12px;color:white}
.role-admin{background:#ff6b6b}
.role-teacher{background:#ffd93d;color:#333}
.role-student{background:#6bcb77}
.action-btns{display:flex;gap:5px;flex-wrap:wrap}
.online-badge{background:#6bcb77;color:white;padding:2px 8px;border-radius:10px;font-size:11px}
.offline-badge{background:#999;color:white;padding:2px 8px;border-radius:10px;font-size:11px}
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center}
.modal-overlay.active{display:flex}
.modal{background:white;padding:25px;border-radius:15px;width:95%;max-width:600px;max-height:90vh;overflow-y:auto}
.modal h2{margin-bottom:20px;color:#333;font-size:18px}
.modal .close-btn{float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999}
.modal .close-btn:hover{color:#333}
.detail-view{background:#f5f5f5;padding:15px;border-radius:8px;margin:10px 0}
.detail-view h4{margin-bottom:10px;color:#333}
.alert{padding:12px;border-radius:8px;margin-bottom:15px;font-size:14px}
.alert-error{background:#ffe6e6;color:#cc0000}
.alert-success{background:#e6ffe6;color:#006600}
.filter-bar{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;align-items:center}
.filter-bar input,.filter-bar select{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px}
.log-entry{padding:10px;border-bottom:1px solid #eee;font-size:13px}
.log-entry .time{color:#999;font-size:12px}
.log-entry .action{color:#667eea;font-weight:500}
.empty-message{text-align:center;color:#999;padding:30px}
.option-item{display:flex;gap:10px;margin-bottom:8px;align-items:center}
.option-item input{flex:1}
.option-item button{background:#ff6b6b;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer}
.file-upload{border:2px dashed #ddd;padding:20px;text-align:center;border-radius:8px;cursor:pointer;margin:10px 0}
.file-upload:hover{border-color:#667eea}
.file-list{list-style:none;padding:0}
.file-list li{padding:8px;background:#f5f5f5;margin:5px 0;border-radius:5px;display:flex;justify-content:space-between;align-items:center}
.file-icon{margin-right:8px}
.whiteboard-container{background:white;border-radius:8px;padding:10px;margin:10px 0}
.whiteboard-toolbar{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.whiteboard-toolbar button{padding:8px 15px;border:1px solid #ddd;background:white;border-radius:5px;cursor:pointer}
.whiteboard-toolbar button.active{background:#667eea;color:white;border-color:#667eea}
.whiteboard-canvas{width:100%;height:400px;border:1px solid #ddd;border-radius:8px;cursor:crosshair}
@media (max-width:768px){.form-row{grid-template-columns:1fr}.header{text-align:center}.header h1{width:100%}}
</style>
</head>
<body>
<div id="loginContainer" class="login-container">
<div class="login-box">
<h1 style="margin-bottom:10px">LMS-Edge</h1>
<p class="subtitle" style="color:#666;margin-bottom:25px">ç­çº§å±€åŸŸç½‘æ•™å­¦ç®¡ç†ç³»ç»Ÿ</p>
<div class="form-group">
<label>ç”¨æˆ·å</label>
<input type="text" id="username" placeholder="admin / teacher / student">
</div>
<div class="form-group">
<label>å¯†ç </label>
<input type="password" id="password" placeholder="è¾“å…¥å¯†ç ">
</div>
<button class="btn btn-primary" style="width:100%;padding:12px;font-size:16px" onclick="doLogin()">ç™»å½•</button>
<div style="margin-top:20px;text-align:left;background:#f5f5f5;padding:15px;border-radius:10px">
<h4 style="margin-bottom:10px;font-size:14px">æµ‹è¯•è´¦å·</h4>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
<div><span class="role-badge role-admin">ç®¡ç†å‘˜</span> admin / admin123</div>
<div><span class="role-badge role-teacher">è€å¸ˆ</span> teacher / teacher123</div>
<div><span class="role-badge role-student">å­¦ç”Ÿ</span> student / student123</div>
</div>
</div>
</div>
</div>

<div id="dashboardContainer" class="dashboard-container">
<div class="container">
<div class="header">
<h1>LMS-Edge æ•™å­¦ç®¡ç†ç³»ç»Ÿ</h1>
<div class="user-info">
<span id="welcomeUser">æ¬¢è¿å›æ¥</span>
<span id="lastActive" style="color:#999;font-size:12px"></span>
<button class="logout-btn" onclick="doLogout()">é€€å‡ºç™»å½•</button>
</div>
</div>

<div class="stats-row">
<div class="stat-card"><h3 id="statStudents">0</h3><p>å­¦ç”Ÿæ•°</p></div>
<div class="stat-card"><h3 id="statAssignments">0</h3><p>ä½œä¸šæ€»æ•°</p></div>
<div class="stat-card"><h3 id="statOnline">0</h3><p>åœ¨çº¿äººæ•°</p></div>
<div class="stat-card"><h3 id="statSessions">0</h3><p>å­¦ä¹ äººæ¬¡</p></div>
</div>

<div id="adminNav" class="nav-tabs" style="display:none">
<button class="active" onclick="showSection('users',this)">ç”¨æˆ·ç®¡ç†</button>
<button onclick="showSection('assignments',this)">ä½œä¸šç®¡ç†</button>
<button onclick="showSection('attendance',this)">è€ƒå‹¤è®°å½•</button>
<button onclick="showSection('whiteboard',this)">ç™½æ¿</button>
<button onclick="showSection('logs',this)">æ“ä½œæ—¥å¿—</button>
</div>

<div id="teacherNav" class="nav-tabs" style="display:none">
<button onclick="showSection('attendance',this)">è€ƒå‹¤è®°å½•</button>
<button onclick="showSection('assignments',this)">ä½œä¸šç®¡ç†</button>
<button onclick="showSection('whiteboard',this)">ç™½æ¿</button>
</div>

<div id="studentNav" class="nav-tabs" style="display:none">
<button class="active" onclick="showSection('myAssignments',this)">æˆ‘çš„ä½œä¸š</button>
<button onclick="showSection('mySubmissions',this)">æˆ‘çš„ä½œç­”</button>
<button onclick="showSection('whiteboard',this)">ç™½æ¿</button>
</div>

<div id="usersSection" class="content-section active">
<h3 style="margin-bottom:15px">ç”¨æˆ·ç®¡ç†</h3>
<div class="filter-bar">
<button class="btn btn-primary btn-sm" onclick="showUserModal()">æ–°å¢ç”¨æˆ·</button>
<input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·å..." onkeyup="loadUsers()">
<select id="roleFilter" onchange="loadUsers()">
<option value="">å…¨éƒ¨è§’è‰²</option>
<option value="admin">ç®¡ç†å‘˜</option>
<option value="teacher">è€å¸ˆ</option>
<option value="student">å­¦ç”Ÿ</option>
</select>
</div>
<table id="usersTable">
<thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>å§“å</th><th>è§’è‰²</th><th>çŠ¶æ€</th><th>æœ€åæ´»è·ƒ</th><th>æ“ä½œ</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div id="assignmentsSection" class="content-section">
<h3 style="margin-bottom:15px">ä½œä¸šç®¡ç†</h3>
<div class="filter-bar">
<button class="btn btn-primary btn-sm" onclick="showAssignmentModal()">åˆ›å»ºä½œä¸š</button>
<input type="text" id="assignmentSearch" placeholder="æœç´¢ä½œä¸š..." onkeyup="loadAssignments()">
</div>
<table id="assignmentsTable">
<thead><tr><th>ID</th><th>æ ‡é¢˜</th><th>ç±»å‹</th><th>åˆ†å€¼</th><th>æäº¤æ•°</th><th>åˆ›å»ºè€…</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div id="attendanceSection" class="content-section">
<h3 style="margin-bottom:15px">è€ƒå‹¤è®°å½•</h3>
<div class="filter-bar">
<button class="btn btn-primary btn-sm" onclick="loadOnlineUsers()">åˆ·æ–°åœ¨çº¿çŠ¶æ€</button>
</div>
<div class="stats-row" style="margin-bottom:20px">
<div class="stat-card"><h3 id="onlineCount">0</h3><p>å½“å‰åœ¨çº¿</p></div>
</div>
<table id="attendanceTable">
<thead><tr><th>ç”¨æˆ·</th><th>è§’è‰²</th><th>ç™»å½•æ—¶é—´</th><th>æœ€åæ´»è·ƒ</th><th>æ—¶é•¿</th><th>çŠ¶æ€</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div id="whiteboardSection" class="content-section">
<h3 style="margin-bottom:15px">åä½œç™½æ¿</h3>
<div class="whiteboard-toolbar">
<button class="active" onclick="setTool('pen')">ç”»ç¬”</button>
<button onclick="setTool('eraser')">æ©¡çš®</button>
<button onclick="setTool('line')">ç›´çº¿</button>
<button onclick="setTool('rect')">çŸ©å½¢</button>
<button onclick="setTool('circle')">åœ†å½¢</button>
<button onclick="setTool('text')">æ–‡å­—</button>
<input type="color" id="colorPicker" value="#000000" style="width:50px;height:35px">
<button onclick="clearWhiteboard()">æ¸…ç©º</button>
</div>
<canvas id="whiteboardCanvas" class="whiteboard-canvas"></canvas>
<div id="whiteboardStatus" style="margin-top:10px;color:#666;font-size:13px"></div>
</div>

<div id="logsSection" class="content-section">
<h3 style="margin-bottom:15px">æ“ä½œæ—¥å¿—</h3>
<div id="logsList"></div>
</div>

<div id="myAssignmentsSection" class="content-section active">
<h3 style="margin-bottom:15px">å¯ç”¨ä½œä¸š</h3>
<table id="myAssignmentsTable">
<thead><tr><th>ID</th><th>æ ‡é¢˜</th><th>ç±»å‹</th><th>åˆ†å€¼</th><th>é™„ä»¶</th><th>æ“ä½œ</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div id="mySubmissionsSection" class="content-section">
<h3 style="margin-bottom:15px">æˆ‘çš„ä½œç­”</h3>
<table id="mySubmissionsTable">
<thead><tr><th>ä½œä¸š</th><th>æˆ‘çš„ç­”æ¡ˆ</th><th>å¾—åˆ†</th><th>é™„ä»¶</th><th>æäº¤æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>

<div id="userModal" class="modal-overlay">
<div class="modal">
<span class="close-btn" onclick="closeModal('userModal')">&times;</span>
<h2 id="userModalTitle">æ–°å¢ç”¨æˆ·</h2>
<div class="form-group">
<label>ç”¨æˆ·å *</label>
<input type="text" id="editUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
</div>
<div class="form-group">
<label>å§“å</label>
<input type="text" id="editFullName" placeholder="è¾“å…¥å§“å">
</div>
<div class="form-group">
<label>è§’è‰² *</label>
<select id="editRole">
<option value="student">å­¦ç”Ÿ</option>
<option value="teacher">è€å¸ˆ</option>
<option value="admin">ç®¡ç†å‘˜</option>
</select>
</div>
<div class="form-group" id="passwordGroup">
<label id="passwordLabel">åˆå§‹å¯†ç  *</label>
<input type="password" id="editPassword" placeholder="è¾“å…¥å¯†ç ">
</div>
<input type="hidden" id="editUserId">
<button class="btn btn-primary" style="width:100%" onclick="saveUser()">ä¿å­˜</button>
</div>
</div>

<div id="assignmentModal" class="modal-overlay">
<div class="modal">
<span class="close-btn" onclick="closeModal('assignmentModal')">&times;</span>
<h2 id="assignmentModalTitle">åˆ›å»ºä½œä¸š</h2>
<div class="form-group">
<label>ä½œä¸šæ ‡é¢˜ *</label>
<input type="text" id="assignTitle" placeholder="è¾“å…¥ä½œä¸šæ ‡é¢˜">
</div>
<div class="form-group">
<label>ä½œä¸šå†…å®¹</label>
<textarea id="assignContent" placeholder="è¾“å…¥ä½œä¸šè¯¦ç»†å†…å®¹..."></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>ä½œä¸šç±»å‹</label>
<select id="assignType" onchange="toggleAssignmentFields()">
<option value="single_choice">å•é€‰é¢˜</option>
<option value="multiple_choice">å¤šé€‰é¢˜</option>
<option value="programming">æœºè¯•é¢˜</option>
</select>
</div>
<div class="form-group">
<label>åˆ†å€¼</label>
<input type="number" id="assignPoints" value="10" min="1">
</div>
</div>
<div id="choiceFields">
<div class="form-group">
<label>é€‰é¡¹</label>
<div id="optionsList"></div>
<button class="btn btn-sm" onclick="addOption()" style="margin-top:5px">+ æ·»åŠ é€‰é¡¹</button>
</div>
<div class="form-group">
<label>æ­£ç¡®ç­”æ¡ˆ</label>
<input type="text" id="assignAnswer" placeholder="è¾“å…¥æ­£ç¡®ç­”æ¡ˆ">
</div>
</div>
<div id="programmingFields" style="display:none">
<div class="form-group">
<label>ä¸Šä¼ é™„ä»¶</label>
<div class="file-upload" onclick="document.getElementById('assignmentFile').click()">
<p>ç‚¹å‡»ä¸Šä¼ é™„ä»¶</p>
<p style="font-size:12px;color:#999">æ”¯æŒ: xlsx, xls, doc, docx, zip, rar, jpg, png</p>
<input type="file" id="assignmentFile" style="display:none" onchange="handleAssignmentFile(this)">
</div>
<ul id="attachmentList" class="file-list"></ul>
</div>
</div>
<input type="hidden" id="editAssignmentId">
<button class="btn btn-primary" style="width:100%" onclick="saveAssignment()">ä¿å­˜</button>
</div>
</div>

<div id="detailModal" class="modal-overlay">
<div class="modal" style="max-width:700px">
<span class="close-btn" onclick="closeModal('detailModal')">&times;</span>
<h2 id="detailModalTitle">ä½œä¸šè¯¦æƒ…</h2>
<div id="detailContent"></div>
</div>
</div>

<div id="submitModal" class="modal-overlay">
<div class="modal">
<span class="close-btn" onclick="closeModal('submitModal')">&times;</span>
<h2 id="submitModalTitle">æäº¤ä½œä¸š</h2>
<div id="submitAssignmentInfo" class="detail-view"></div>
<div id="submitChoiceFields">
<div class="form-group">
<label>æˆ‘çš„ç­”æ¡ˆ</label>
<div id="submitOptionsList"></div>
</div>
</div>
<div id="submitProgrammingFields" style="display:none">
<div class="form-group">
<label>ä¸Šä¼ ä½œç­”æ–‡ä»¶</label>
<div class="file-upload" onclick="document.getElementById('submissionFile').click()">
<p>ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</p>
<p style="font-size:12px;color:#999">æ”¯æŒ: zip, rar, jpg, png, pdf, doc, docx</p>
<input type="file" id="submissionFile" style="display:none" onchange="handleSubmissionFile(this)">
</div>
<ul id="submissionFileList" class="file-list"></ul>
</div>
</div>
<input type="hidden" id="submitAssignmentId">
<input type="hidden" id="currentSubmissionId">
<button class="btn btn-primary" style="width:100%" onclick="submitAssignment()">æäº¤</button>
</div>
</div>

<div id="passwordModal" class="modal-overlay">
<div class="modal">
<span class="close-btn" onclick="closeModal('passwordModal')">&times;</span>
<h2>ä¿®æ”¹å¯†ç </h2>
<div class="form-group">
<label>åŸå¯†ç </label>
<input type="password" id="oldPassword" placeholder="è¾“å…¥åŸå¯†ç ">
</div>
<div class="form-group">
<label>æ–°å¯†ç </label>
<input type="password" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ">
</div>
<div class="form-group">
<label>ç¡®è®¤æ–°å¯†ç </label>
<input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
</div>
<button class="btn btn-primary" style="width:100%" onclick="changePassword()">ç¡®è®¤ä¿®æ”¹</button>
</div>
</div>

<script>
var API_URL = window.location.origin;
var currentUser = null;
var SESSION_TIMEOUT = 24 * 60 * 60 * 1000;
var sessionTimer = null;
var currentAssignmentFile = null;
var currentSubmissionFile = null;
var sessionEventHandler = null;

function getSession() {
    var session = localStorage.getItem('lms_session');
    if (session) {
        try {
            var data = JSON.parse(session);
            if (data && data.user && data.loginTime) {
                var now = Date.now();
                if (now - data.loginTime < SESSION_TIMEOUT) {
                    return data;
                }
            }
            localStorage.removeItem('lms_session');
        } catch (e) {
            localStorage.removeItem('lms_session');
        }
    }
    return null;
}

function saveSession(user, token) {
    var session = {user: user, token: token, loginTime: Date.now()};
    localStorage.setItem('lms_session', JSON.stringify(session));
    setupSessionTimer();
}

function setupSessionTimer() {
    if (sessionTimer) {
        clearTimeout(sessionTimer);
    }
    sessionTimer = setTimeout(function() {
        forceLogout();
    }, SESSION_TIMEOUT);
}

function forceLogout() {
    localStorage.removeItem('lms_session');
    currentUser = null;
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('dashboardContainer').style.display = 'none';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    removeSessionListeners();
    alert('ç™»å½•å·²è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•');
}

function addSessionListeners() {
    removeSessionListeners();
    sessionEventHandler = function() {
        setupSessionTimer();
    };
    document.addEventListener('click', sessionEventHandler);
    document.addEventListener('keypress', sessionEventHandler);
}

function removeSessionListeners() {
    if (sessionEventHandler) {
        document.removeEventListener('click', sessionEventHandler);
        document.removeEventListener('keypress', sessionEventHandler);
        sessionEventHandler = null;
    }
}

function initSession() {
    var session = getSession();
    if (session && session.user) {
        currentUser = session.user;
        showDashboard();
        setupSessionTimer();
        addSessionListeners();
    }
}

async function doLogin() {
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;
    if (!username || !password) {alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');return;}
    try {
        var res = await fetch(API_URL + '/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: username, password: password})
        });
        var data = await res.json();
        if (data.token) {
            currentUser = data.user;
            saveSession(data.user, data.token);
            showDashboard();
        } else {
            alert(data.error || 'ç™»å½•å¤±è´¥');
        }
    } catch (e) {
        alert('è¿æ¥å¤±è´¥: ' + e.message);
    }
}

function doLogout() {
    localStorage.removeItem('lms_session');
    currentUser = null;
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('dashboardContainer').style.display = 'none';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    if (sessionTimer) {
        clearTimeout(sessionTimer);
        sessionTimer = null;
    }
    removeSessionListeners();
}

function showDashboard() {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'block';
    document.getElementById('welcomeUser').textContent = 'æ¬¢è¿, ' + (currentUser.full_name || currentUser.username) + ' (' + getRoleName(currentUser.role) + ')';
    document.getElementById('adminNav').style.display = currentUser.role === 'admin' ? 'flex' : 'none';
    document.getElementById('teacherNav').style.display = currentUser.role === 'teacher' ? 'flex' : 'none';
    document.getElementById('studentNav').style.display = currentUser.role === 'student' ? 'flex' : 'none';
    loadAllStats();
    var firstSection = currentUser.role === 'student' ? 'myAssignments' : (currentUser.role === 'teacher' ? 'attendance' : 'users');
    showSection(firstSection, null);
    if (currentUser.role === 'student') autoSignin();
}

function getRoleName(role) {
    var names = {admin: 'ç®¡ç†å‘˜', teacher: 'è€å¸ˆ', student: 'å­¦ç”Ÿ'};
    return names[role] || role;
}

function showSection(section, btn) {
    document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-tabs button').forEach(el => el.classList.remove('active'));
    if (btn) btn.classList.add('active');
    var sectionMap = {
        'users': 'usersSection', 'assignments': 'assignmentsSection', 'attendance': 'attendanceSection',
        'stats': 'statsSection', 'logs': 'logsSection', 'whiteboard': 'whiteboardSection',
        'myAssignments': 'myAssignmentsSection', 'mySubmissions': 'mySubmissionsSection'
    };
    var el = document.getElementById(sectionMap[section]);
    if (el) el.classList.add('active');
    if (section === 'users') loadUsers();
    if (section === 'assignments') loadAssignments();
    if (section === 'attendance') { loadAttendanceRecords(); loadOnlineUsers(); }
    if (section === 'stats') loadClassStats();
    if (section === 'logs') loadLogs();
    if (section === 'whiteboard') initWhiteboard();
    if (section === 'myAssignments') loadMyAssignments();
    if (section === 'mySubmissions') loadMySubmissions();
}

async function loadAllStats() {
    try {
        var res = await fetch(API_URL + '/api/info?role=' + currentUser.role);
        var data = await res.json();
        document.getElementById('statStudents').textContent = data.students || 0;
        document.getElementById('statAssignments').textContent = data.assignments || 0;
        document.getElementById('statSessions').textContent = data.students || 0;
    } catch (e) {console.error(e);}
}

async function loadUsers() {
    try {
        var res = await fetch(API_URL + '/api/users');
        var data = await res.json();
        var tbody = document.querySelector('#usersTable tbody');
        var html = '';
        var search = document.getElementById('userSearch').value.toLowerCase();
        var roleFilter = document.getElementById('roleFilter').value;
        for (var u of (data.users || [])) {
            if (search && !u.username.toLowerCase().includes(search) && !(u.full_name || '').toLowerCase().includes(search)) continue;
            if (roleFilter && u.role !== roleFilter) continue;
            var isOnline = u.last_active && new Date(u.last_active) > new Date(Date.now() - 5*60*1000);
            var lastActive = u.last_active ? new Date(u.last_active).toLocaleString() : '-';
            html += '<tr><td>' + u.id + '</td><td>' + u.username + '</td><td>' + (u.full_name || '-') + '</td><td><span class="role-badge role-' + u.role + '">' + getRoleName(u.role) + '</span></td><td><span class="' + (isOnline ? 'online-badge' : 'offline-badge') + '">' + (isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿') + '</span></td><td>' + lastActive + '</td><td class="action-btns">';
            if (currentUser.role === 'admin') {
                html += '<button class="btn btn-primary btn-sm" onclick="editUser(' + u.id + ',\'' + u.username + '\',\'' + (u.full_name || '') + '\',\'' + u.role + '\')">ç¼–è¾‘</button>';
                if (u.id !== 1) {
                    html += '<button class="btn btn-danger btn-sm" onclick="deleteUser(' + u.id + ',\'' + u.username + '\')">åˆ é™¤</button>';
                }
            }
            html += '</td></tr>';
        }
        tbody.innerHTML = html || '<tr><td colspan="7" class="empty-message">æš‚æ— ç”¨æˆ·</td></tr>';
    } catch (e) {console.error(e);}
}

function showUserModal(id, username, fullName, role) {
    document.getElementById('userModalTitle').textContent = id ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ–°å¢ç”¨æˆ·';
    document.getElementById('editUserId').value = id || '';
    document.getElementById('editUsername').value = username || '';
    document.getElementById('editFullName').value = fullName || '';
    document.getElementById('editRole').value = role || 'student';
    document.getElementById('editPassword').value = '';
    document.getElementById('passwordLabel').textContent = id ? 'æ–°å¯†ç  (ç•™ç©ºä¸ä¿®æ”¹)' : 'åˆå§‹å¯†ç  *';
    document.getElementById('userModal').classList.add('active');
}

function editUser(id, username, fullName, role) {
    if (role === 'admin' && id !== 1 && currentUser.role !== 'admin') {
        alert('ä¸èƒ½ç¼–è¾‘ç®¡ç†å‘˜è´¦æˆ·');return;
    }
    showUserModal(id, username, fullName, role);
}

async function saveUser() {
    var id = document.getElementById('editUserId').value;
    var username = document.getElementById('editUsername').value;
    var fullName = document.getElementById('editFullName').value;
    var role = document.getElementById('editRole').value;
    var password = document.getElementById('editPassword').value;
    
    if (!username) {alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');return;}
    if (!id && !password) {alert('åˆå§‹å¯†ç ä¸èƒ½ä¸ºç©º');return;}
    
    var data = {username: username, full_name: fullName, role: role};
    if (password) data.password = password;
    if (id) data.id = parseInt(id);
    
    try {
        var url = id ? API_URL + '/api/users/' : API_URL + '/api/users/create';
        var method = id ? 'PUT' : 'POST';
        var res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        var result = await res.json();
        if (res.ok && (result.success || result.id)) {
            closeModal('userModal');
            loadUsers();
        } else {
            alert(result.error || 'æ“ä½œå¤±è´¥');
        }
    } catch (e) {alert('æ“ä½œå¤±è´¥: ' + e.message);}
}

async function deleteUser(id, username) {
    if (id === 1) {alert('ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦æˆ·');return;}
    if (!confirm('ç¡®å®šåˆ é™¤ç”¨æˆ· "' + username + '"ï¼Ÿ')) return;
    try {
        var res = await fetch(API_URL + '/api/users/' + id, {method: 'DELETE'});
        var data = await res.json();
        if (data.success) {loadUsers();} else {alert(data.error || 'åˆ é™¤å¤±è´¥');}
    } catch (e) {alert('åˆ é™¤å¤±è´¥: ' + e.message);}
}

async function loadAssignments() {
    try {
        var res = await fetch(API_URL + '/api/assignments/all');
        var data = await res.json();
        var tbody = document.querySelector('#assignmentsTable tbody');
        var html = '';
        var search = document.getElementById('assignmentSearch').value.toLowerCase();
        if (data.assignments && data.assignments.length > 0) {
            for (var a of data.assignments) {
                if (search && !a.title.toLowerCase().includes(search)) continue;
                var typeName = a.assignment_type === 'single_choice' ? 'å•é€‰' : (a.assignment_type === 'multiple_choice' ? 'å¤šé€‰' : 'æœºè¯•');
                html += '<tr><td>' + a.id + '</td><td><a href="javascript:void(0)" onclick="viewAssignmentDetail(' + a.id + ',\'' + a.title + '\')">' + a.title + '</a></td><td>' + typeName + '</td><td>' + a.points + '</td><td>' + (a.submission_count || 0) + '</td><td>' + (a.creator_name || 'æœªçŸ¥') + '</td><td>' + new Date(a.created_at).toLocaleString() + '</td><td class="action-btns">';
                if (currentUser.role === 'admin' || currentUser.role === 'teacher') {
                    html += '<button class="btn btn-primary btn-sm" onclick="editAssignment(' + a.id + ',\'' + a.title + '\',\'' + (a.content || '').replace(/'/g, "\\'") + '\',\'' + a.assignment_type + '\',' + a.points + ',\'' + (a.correct_answer || '') + '\')">ç¼–è¾‘</button>';
                    html += '<button class="btn btn-danger btn-sm" onclick="deleteAssignment(' + a.id + ',\'' + a.title + '\')">åˆ é™¤</button>';
                }
                html += '</td></tr>';
            }
        } else {
            html = '<tr><td colspan="8" class="empty-message">æš‚æ— ä½œä¸š</td></tr>';
        }
        tbody.innerHTML = html;
    } catch (e) {console.error(e);}
}

function showAssignmentModal(id, title, content, type, points, answer) {
    document.getElementById('assignmentModalTitle').textContent = id ? 'ç¼–è¾‘ä½œä¸š' : 'åˆ›å»ºä½œä¸š';
    document.getElementById('editAssignmentId').value = id || '';
    document.getElementById('assignTitle').value = title || '';
    document.getElementById('assignContent').value = content || '';
    document.getElementById('assignType').value = type || 'single_choice';
    document.getElementById('assignPoints').value = points || 10;
    document.getElementById('assignAnswer').value = answer || '';
    document.getElementById('attachmentList').innerHTML = '';
    document.getElementById('assignmentFile').value = '';
    currentAssignmentFile = null;
    toggleAssignmentFields();
    document.getElementById('assignmentModal').classList.add('active');
}

function editAssignment(id, title, content, type, points, answer) {
    showAssignmentModal(id, title, content, type, points, answer);
}

function toggleAssignmentFields() {
    var type = document.getElementById('assignType').value;
    document.getElementById('choiceFields').style.display = (type === 'single_choice' || type === 'multiple_choice') ? 'block' : 'none';
    document.getElementById('programmingFields').style.display = type === 'programming' ? 'block' : 'none';
    if (type === 'single_choice') {
        document.getElementById('assignAnswer').placeholder = 'è¾“å…¥æ­£ç¡®é€‰é¡¹åºå·ï¼Œå¦‚ A';
    } else if (type === 'multiple_choice') {
        document.getElementById('assignAnswer').placeholder = 'è¾“å…¥æ­£ç¡®é€‰é¡¹ï¼Œå¦‚ AB';
    } else {
        document.getElementById('assignAnswer').placeholder = '';
    }
}

function addOption() {
    var list = document.getElementById('optionsList');
    var idx = list.children.length;
    var div = document.createElement('div');
    div.className = 'option-item';
    div.innerHTML = '<span style="width:30px">' + String.fromCharCode(65 + idx) + '</span><input type="text" placeholder="é€‰é¡¹å†…å®¹"><button onclick="this.parentElement.remove()">åˆ é™¤</button>';
    list.appendChild(div);
}

function handleAssignmentFile(input) {
    if (input.files[0]) {
        currentAssignmentFile = input.files[0];
        var list = document.getElementById('attachmentList');
        list.innerHTML = '<li><span class="file-icon">ğŸ“</span>' + currentAssignmentFile.name + '</li>';
    }
}

async function saveAssignment() {
    var id = document.getElementById('editAssignmentId').value;
    var title = document.getElementById('assignTitle').value;
    var content = document.getElementById('assignContent').value;
    var type = document.getElementById('assignType').value;
    var points = parseInt(document.getElementById('assignPoints').value) || 10;
    var answer = document.getElementById('assignAnswer').value;
    
    if (!title) {alert('ä½œä¸šæ ‡é¢˜ä¸èƒ½ä¸ºç©º');return;}
    
    var data = {title: title, content: content, assignment_type: type, points: points};
    
    if (type === 'single_choice' || type === 'multiple_choice') {
        var options = [];
        document.querySelectorAll('#optionsList input').forEach(function(input) {
            if (input.value) options.push(input.value);
        });
        data.options = options;
        data.correct_answer = answer;
    }
    
    try {
        var url = id ? API_URL + '/api/assignments/' + id : API_URL + '/api/assignments/create';
        var method = id ? 'PUT' : 'POST';
        if (!id) data.created_by = currentUser.id;
        
        var res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        var result = await res.json();
        
        if (result.success || result.id) {
            var assignmentId = result.id || id;
            if (currentAssignmentFile) {
                try {
                    var formData = new FormData();
                    formData.append('file', currentAssignmentFile);
                    var uploadRes = await fetch(API_URL + '/api/attachments/' + assignmentId, {method: 'POST', body: formData});
                    var uploadResult = await uploadRes.json();
                    if (!uploadResult.success) {
                        alert('é™„ä»¶ä¸Šä¼ å¤±è´¥: ' + (uploadResult.error || 'æœªçŸ¥é”™è¯¯'));
                        return;
                    }
                } catch (e) {
                    alert('é™„ä»¶ä¸Šä¼ å¤±è´¥: ' + e.message);
                    return;
                }
            }
            closeModal('assignmentModal');
            loadAssignments();
        } else {
            alert(result.error || 'æ“ä½œå¤±è´¥');
        }
    } catch (e) {alert('æ“ä½œå¤±è´¥: ' + e.message);}
}

async function deleteAssignment(id, title) {
    if (!confirm('ç¡®å®šåˆ é™¤ä½œä¸š "' + title + '"ï¼Ÿ')) return;
    try {
        var res = await fetch(API_URL + '/api/assignments/' + id, {method: 'DELETE'});
        var data = await res.json();
        if (data.success) {loadAssignments();} else {alert(data.error || 'åˆ é™¤å¤±è´¥');}
    } catch (e) {alert('åˆ é™¤å¤±è´¥: ' + e.message);}
}

async function viewAssignmentDetail(id, title) {
    try {
        var res = await fetch(API_URL + '/api/assignments/' + id);
        var data = await res.json();
        var html = '<div class="detail-view"><h4>' + data.assignment.title + '</h4><p><strong>å†…å®¹:</strong> ' + (data.assignment.content || 'æ— ') + '</p><p><strong>ç±»å‹:</strong> ' + (data.assignment.assignment_type === 'single_choice' ? 'å•é€‰' : (data.assignment.assignment_type === 'multiple_choice' ? 'å¤šé€‰' : 'æœºè¯•')) + '</p><p><strong>åˆ†å€¼:</strong> ' + data.assignment.points + '</p></div>';
        if (data.assignment.attachment) {
            html += '<div class="form-group"><label>é™„ä»¶:</label><a href="' + API_URL + '/api/attachments/' + data.assignment.id + '/' + data.assignment.attachment + '" target="_blank" class="btn btn-sm btn-primary">ä¸‹è½½é™„ä»¶</a></div>';
        }
        html += '<h4 style="margin-top:15px">å­¦ç”Ÿä½œç­” (' + (data.submissions || []).length + ')</h4>';
        if (data.submissions && data.submissions.length > 0) {
            html += '<table style="font-size:13px"><thead><tr><th>å­¦ç”Ÿ</th><th>ç­”æ¡ˆ</th><th>å¾—åˆ†</th><th>é™„ä»¶</th><th>æäº¤æ—¶é—´</th></tr></thead><tbody>';
            for (var s of data.submissions) {
                var attachmentLink = s.attachment ? '<a href="' + API_URL + '/api/submissions/file/' + s.id + '/' + s.attachment + '" target="_blank">ä¸‹è½½</a>' : '-';
                html += '<tr><td>' + (s.full_name || s.username) + '</td><td>' + (s.student_answer || '-') + '</td><td>' + s.score + '</td><td>' + attachmentLink + '</td><td>' + new Date(s.submitted_at).toLocaleString() + '</td></tr>';
            }
            html += '</tbody></table>';
        } else {
            html += '<p class="empty-message">æš‚æ— ä½œç­”</p>';
        }
        document.getElementById('detailModalTitle').textContent = 'ä½œä¸šè¯¦æƒ… - ' + title;
        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailModal').classList.add('active');
    } catch (e) {alert('è·å–è¯¦æƒ…å¤±è´¥: ' + e.message);}
}

async function loadMyAssignments() {
    try {
        var res = await fetch(API_URL + '/api/assignments');
        var data = await res.json();
        var tbody = document.querySelector('#myAssignmentsTable tbody');
        var html = '';
        if (data.assignments && data.assignments.length > 0) {
            for (var a of data.assignments) {
                var typeName = a.assignment_type === 'single_choice' ? 'å•é€‰' : (a.assignment_type === 'multiple_choice' ? 'å¤šé€‰' : 'æœºè¯•');
                var attachmentLink = a.attachment ? '<a href="' + API_URL + '/api/attachments/' + a.id + '/' + a.attachment + '" target="_blank">ğŸ“ä¸‹è½½</a>' : '-';
                html += '<tr><td>' + a.id + '</td><td>' + a.title + '</td><td>' + typeName + '</td><td>' + a.points + '</td><td>' + attachmentLink + '</td><td><button class="btn btn-success btn-sm" onclick="showSubmitModal(' + a.id + ',\'' + a.title + '\')">ä½œç­”</button></td></tr>';
            }
        } else {
            html = '<tr><td colspan="6" class="empty-message">æš‚æ— ä½œä¸š</td></tr>';
        }
        tbody.innerHTML = html;
    } catch (e) {console.error(e);}
}

async function showSubmitModal(id, title) {
    try {
        var res = await fetch(API_URL + '/api/assignments/' + id);
        var data = await res.json();
        var a = data.assignment;
        document.getElementById('submitAssignmentId').value = id;
        document.getElementById('currentSubmissionId').value = data.submissions && data.submissions[0] ? data.submissions[0].id : '';
        document.getElementById('submitModalTitle').textContent = 'æäº¤ - ' + title;
        document.getElementById('submissionFileList').innerHTML = '';
        document.getElementById('submissionFile').value = '';
        currentSubmissionFile = null;
        
        var typeName = a.assignment_type === 'single_choice' ? 'å•é€‰' : (a.assignment_type === 'multiple_choice' ? 'å¤šé€‰' : 'æœºè¯•');
        var attachmentInfo = a.attachment ? '<p><a href="' + API_URL + '/api/attachments/' + a.id + '/' + a.attachment + '" target="_blank">ğŸ“ä¸‹è½½é™„ä»¶: ' + a.attachment + '</a></p>' : '';
        document.getElementById('submitAssignmentInfo').innerHTML = '<p><strong>æ ‡é¢˜:</strong> ' + a.title + '</p><p><strong>ç±»å‹:</strong> ' + typeName + '</p><p><strong>åˆ†å€¼:</strong> ' + a.points + '</p><p><strong>å†…å®¹:</strong> ' + (a.content || 'æ— ') + '</p>' + attachmentInfo;
        
        document.getElementById('submitChoiceFields').style.display = (a.assignment_type === 'single_choice' || a.assignment_type === 'multiple_choice') ? 'block' : 'none';
        document.getElementById('submitProgrammingFields').style.display = a.assignment_type === 'programming' ? 'block' : 'none';
        
        if (a.assignment_type === 'single_choice' || a.assignment_type === 'multiple_choice') {
            var options = a.options ? JSON.parse(a.options) : [];
            var html = '';
            for (var i = 0; i < options.length; i++) {
                var optLetter = String.fromCharCode(65 + i);
                var isChecked = data.submissions && data.submissions[0] && data.submissions[0].student_answer === optLetter;
                html += '<div class="option-item"><input type="radio" name="submitAnswer" value="' + optLetter + '" ' + (isChecked ? 'checked' : '') + '> <span>' + optLetter + '. ' + options[i] + '</span></div>';
            }
            if (a.assignment_type === 'multiple_choice') {
                html = html.replace(/radio/gi, 'checkbox');
            }
            document.getElementById('submitOptionsList').innerHTML = html || '<p>æ— é€‰é¡¹</p>';
        }
        
        document.getElementById('submitModal').classList.add('active');
    } catch (e) {alert('è·å–ä½œä¸šå¤±è´¥: ' + e.message);}
}

function handleSubmissionFile(input) {
    if (input.files[0]) {
        currentSubmissionFile = input.files[0];
        var list = document.getElementById('submissionFileList');
        list.innerHTML = '<li><span class="file-icon">ğŸ“</span>' + currentSubmissionFile.name + '</li>';
    }
}

async function submitAssignment() {
    var assignmentId = document.getElementById('submitAssignmentId').value;
    var submissionId = document.getElementById('currentSubmissionId').value;
    var type = document.querySelector('#submitChoiceFields').style.display !== 'none' ? 'choice' : 'programming';
    var answer = '';
    
    if (type === 'choice') {
        var selected = document.querySelector('input[name="submitAnswer"]:checked');
        answer = selected ? selected.value : '';
        if (!answer) {alert('è¯·é€‰æ‹©ç­”æ¡ˆ');return;}
    }
    
    var data = {user_id: currentUser.id, assignment_id: parseInt(assignmentId), answer: answer};
    
    try {
        var res = await fetch(API_URL + '/api/assignments/submit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        var result = await res.json();
        
        if (result.success) {
            var actualSubmissionId = submissionId || result.submission_id;
            if (currentSubmissionFile && actualSubmissionId) {
                var formData = new FormData();
                formData.append('file', currentSubmissionFile);
                await fetch(API_URL + '/api/submissions/file/' + actualSubmissionId, {method: 'POST', body: formData});
            }
            alert('æäº¤æˆåŠŸï¼å¾—åˆ†: ' + (result.score || 0));
            closeModal('submitModal');
            loadMyAssignments();
            loadMySubmissions();
        } else {
            alert(result.error || 'æäº¤å¤±è´¥');
        }
    } catch (e) {alert('æäº¤å¤±è´¥: ' + e.message);}
}

async function loadMySubmissions() {
    try {
        var res = await fetch(API_URL + '/api/submissions/my?user_id=' + currentUser.id);
        var data = await res.json();
        var tbody = document.querySelector('#mySubmissionsTable tbody');
        var html = '';
        if (data.submissions && data.submissions.length > 0) {
            for (var s of data.submissions) {
                var attachmentLink = s.attachment ? '<a href="' + API_URL + '/api/submissions/file/' + s.id + '/' + s.attachment + '" target="_blank">ğŸ“ä¸‹è½½</a>' : '-';
                html += '<tr><td>' + s.assignment_title + '</td><td>' + (s.student_answer || '-') + '</td><td>' + (s.score !== undefined ? s.score : '-') + '</td><td>' + attachmentLink + '</td><td>' + new Date(s.submitted_at).toLocaleString() + '</td><td class="action-btns"><button class="btn btn-primary btn-sm" onclick="reSubmit(' + s.assignment_id + ',\'' + s.assignment_title + '\',\'' + (s.student_answer || '').replace(/'/g, "\\'") + '\')">ä¿®æ”¹</button><button class="btn btn-danger btn-sm" onclick="deleteMySubmission(' + s.id + ')">åˆ é™¤</button></td></tr>';
            }
        } else {
            html = '<tr><td colspan="6" class="empty-message">æš‚æ— ä½œç­”è®°å½•</td></tr>';
        }
        tbody.innerHTML = html;
    } catch (e) {console.error(e);}
}

function reSubmit(id, title, answer) {
    showSubmitModal(id, title);
}

async function deleteMySubmission(id) {
    if (!confirm('ç¡®å®šåˆ é™¤è¿™ä»½ä½œç­”ï¼Ÿ')) return;
    try {
        var res = await fetch(API_URL + '/api/submissions/' + id, {method: 'DELETE'});
        var data = await res.json();
        if (data.success) {loadMySubmissions();} else {alert(data.error || 'åˆ é™¤å¤±è´¥');}
    } catch (e) {alert('åˆ é™¤å¤±è´¥: ' + e.message);}
}

async function loadOnlineUsers() {
    try {
        var res = await fetch(API_URL + '/api/attendance/online');
        var data = await res.json();
        document.getElementById('onlineCount').textContent = (data.online || []).length;
        var tbody = document.querySelector('#attendanceTable tbody');
        var html = '';
        if (data.online && data.online.length > 0) {
            for (var u of data.online) {
                var lastActive = new Date(u.last_active).toLocaleString();
                html += '<tr><td>' + (u.full_name || u.username) + '</td><td><span class="role-badge role-' + u.role + '">' + getRoleName(u.role) + '</span></td><td>-</td><td>' + lastActive + '</td><td>-</td><td><span class="online-badge">åœ¨çº¿</span></td></tr>';
            }
        }
        tbody.innerHTML = html || '<tr><td colspan="6" class="empty-message">æš‚æ— åœ¨çº¿ç”¨æˆ·</td></tr>';
    } catch (e) {console.error(e);}
}

async function loadAttendanceRecords() {
    try {
        var res = await fetch(API_URL + '/api/attendance/records');
        var data = await res.json();
        var tbody = document.querySelector('#attendanceTable tbody');
        var html = '';
        if (data.records && data.records.length > 0) {
            for (var r of data.records) {
                var duration = r.session_duration ? Math.round(r.session_duration / 60) + 'åˆ†é’Ÿ' : '-';
                var lastActive = r.last_active ? new Date(r.last_active).toLocaleString() : '-';
                var status = r.last_active && new Date(r.last_active) > new Date(Date.now() - 5*60*1000) ? '<span class="online-badge">åœ¨çº¿</span>' : '<span class="offline-badge">ç¦»çº¿</span>';
                html += '<tr><td>' + (r.full_name || r.username) + '</td><td><span class="role-badge role-' + r.role + '">' + getRoleName(r.role) + '</span></td><td>' + new Date(r.login_time).toLocaleString() + '</td><td>' + lastActive + '</td><td>' + duration + '</td><td>' + status + '</td></tr>';
            }
        } else {
            html = '<tr><td colspan="6" class="empty-message">æš‚æ— è€ƒå‹¤è®°å½•</td></tr>';
        }
        tbody.innerHTML = html;
    } catch (e) {console.error(e);}
}

async function loadClassStats() {
    try {
        var res = await fetch(API_URL + '/api/stats/class');
        var data = await res.json();
        document.getElementById('statStudents').textContent = data.total_students || 0;
        document.getElementById('statOnline').textContent = '-';
        document.getElementById('statSessions').textContent = data.today_sessions || 0;
    } catch (e) {console.error(e);}
}

async function loadLogs() {
    try {
        var res = await fetch(API_URL + '/api/logs');
        var data = await res.json();
        var html = '';
        for (var l of (data.logs || [])) {
            html += '<div class="log-entry"><span class="time">' + new Date(l.created_at).toLocaleString() + '</span> <span class="action">' + l.username + '</span> ' + l.action + ' ' + l.target + ': ' + l.details + '</div>';
        }
        document.getElementById('logsList').innerHTML = html || '<p class="empty-message">æš‚æ— æ—¥å¿—</p>';
    } catch (e) {document.getElementById('logsList').innerHTML = '<p class="empty-message">åŠ è½½å¤±è´¥</p>';}
}

function autoSignin() {
    if (currentUser && currentUser.role === 'student') {
        fetch(API_URL + '/api/attendance/auto', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: currentUser.id})
        }).catch(function(e) {console.log('è‡ªåŠ¨ç­¾åˆ°å¤±è´¥:', e);});
    }
}

var whiteboardCanvas, whiteboardCtx, isDrawing = false, lastX = 0, lastY = 0, currentTool = 'pen', whiteboardColor = '#000000';

function initWhiteboard() {
    whiteboardCanvas = document.getElementById('whiteboardCanvas');
    whiteboardCtx = whiteboardCanvas.getContext('2d');
    whiteboardCanvas.width = whiteboardCanvas.offsetWidth;
    whiteboardCanvas.height = 400;
    whiteboardCtx.strokeStyle = '#000';
    whiteboardCtx.lineWidth = 2;
    whiteboardCtx.lineCap = 'round';
    
    whiteboardCanvas.addEventListener('mousedown', startDrawing);
    whiteboardCanvas.addEventListener('mousemove', draw);
    whiteboardCanvas.addEventListener('mouseup', stopDrawing);
    whiteboardCanvas.addEventListener('mouseout', stopDrawing);
    whiteboardCanvas.addEventListener('touchstart', function(e) {
        var touch = e.touches[0];
        var rect = whiteboardCanvas.getBoundingClientRect();
        startDrawing({offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top});
    });
    whiteboardCanvas.addEventListener('touchmove', function(e) {
        var touch = e.touches[0];
        var rect = whiteboardCanvas.getBoundingClientRect();
        draw({offsetX: touch.clientX - rect.left, offsetY: touch.clientY - rect.top});
        e.preventDefault();
    });
    whiteboardCanvas.addEventListener('touchend', stopDrawing);
    
    document.getElementById('colorPicker').addEventListener('change', function(e) {
        whiteboardColor = e.target.value;
        whiteboardCtx.strokeStyle = whiteboardColor;
    });
    
    loadWhiteboard();
}

function setTool(tool) {
    currentTool = tool;
    document.querySelectorAll('.whiteboard-toolbar button').forEach(function(btn) {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

function startDrawing(e) {
    isDrawing = true;
    lastX = e.offsetX;
    lastY = e.offsetY;
}

function draw(e) {
    if (!isDrawing) return;
    whiteboardCtx.beginPath();
    whiteboardCtx.moveTo(lastX, lastY);
    whiteboardCtx.lineTo(e.offsetX, e.offsetY);
    whiteboardCtx.stroke();
    lastX = e.offsetX;
    lastY = e.offsetY;
}

function stopDrawing() {
    isDrawing = false;
    saveWhiteboard();
}

function clearWhiteboard() {
    whiteboardCtx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
    saveWhiteboard();
}

async function saveWhiteboard() {
    var dataUrl = whiteboardCanvas.toDataURL();
    try {
        await fetch(API_URL + '/api/whiteboard', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: currentUser.id, content: dataUrl})
        });
        document.getElementById('whiteboardStatus').textContent = 'å·²ä¿å­˜ - ' + new Date().toLocaleTimeString();
    } catch (e) {console.error('ä¿å­˜ç™½æ¿å¤±è´¥:', e);}
}

async function loadWhiteboard() {
    try {
        var res = await fetch(API_URL + '/api/whiteboard');
        var data = await res.json();
        if (data.updates && data.updates.length > 0) {
            var img = new Image();
            img.onload = function() {
                whiteboardCtx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
                whiteboardCtx.drawImage(img, 0, 0);
            };
            img.src = data.updates[data.updates.length - 1].content;
        }
    } catch (e) {console.error('åŠ è½½ç™½æ¿å¤±è´¥:', e);}
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function doLogout() {
    localStorage.removeItem('lms_session');
    currentUser = null;
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('dashboardContainer').style.display = 'none';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    if (sessionTimer) {
        clearTimeout(sessionTimer);
        sessionTimer = null;
    }
    removeSessionListeners();
}

function changePassword() {
    var oldPwd = document.getElementById('oldPassword').value;
    var newPwd = document.getElementById('newPassword').value;
    var confirmPwd = document.getElementById('confirmPassword').value;
    if (!oldPwd || !newPwd) {alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');return;}
    if (newPwd !== confirmPwd) {alert('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´');return;}
    if (newPwd.length < 6) {alert('å¯†ç é•¿åº¦è‡³å°‘6ä½');return;}
    fetch(API_URL + '/api/users/password', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: currentUser.id, old_password: oldPwd, new_password: newPwd})
    }).then(res => res.json()).then(data => {
        if (data.success) {alert('å¯†ç ä¿®æ”¹æˆåŠŸ');closeModal('passwordModal');} else {alert(data.error || 'ä¿®æ”¹å¤±è´¥');}
    }).catch(e => alert('ä¿®æ”¹å¤±è´¥: ' + e.message));
}

document.getElementById('passwordModal') && document.getElementById('passwordModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('passwordModal');
});
document.getElementById('userModal') && document.getElementById('userModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('userModal');
});
document.getElementById('assignmentModal') && document.getElementById('assignmentModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('assignmentModal');
});
document.getElementById('detailModal') && document.getElementById('detailModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('detailModal');
});
document.getElementById('submitModal') && document.getElementById('submitModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal('submitModal');
});

initSession();
</script>
</body>
</html>
